<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mantis Navigation</title>
    <style>
    :root {
        --chem-panel-width: 340px;
    }
    body {
        

            margin: 0;
            overflow: hidden;
            background-color: #111;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }
        #threejs-canvas {
            
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        #ui-container {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 80%;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }
        .control-area {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #joystick-base {
            width: 150px;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
            pointer-events: all;
        }
        #joystick-stick {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            top: 40px;
            left: 40px;
            cursor: grab;
        }
        #thrust-container {
            width: 100px;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            gap: 15px;
        }
        #thrust-slider {
            -webkit-appearance: none; appearance: none;
            width: 150px; height: 15px; background: rgba(255, 255, 255, 0.2);
            outline: none; border-radius: 10px; transform: rotate(-90deg);
            cursor: pointer; margin: 0;
        }
        #thrust-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 25px; height: 25px; background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
        }
        #idle-button {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; font-family: 'Courier New', Courier, monospace;
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            margin-top: 60px; transform: translateY(20px);
        }
        #info-panel {
            position: absolute; top: 10px; left: 10px;
            padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px;
            display: flex; flex-direction: column; gap: 8px; width: 290px;
            z-index: 10;
        }
        .model-action-btn {
            display: none; width: 100%; padding: 8px;
            background-color: rgba(255, 255, 255, 0.3); border: 1px solid rgba(255, 255, 255, 0.5);
            color: white; border-radius: 5px; cursor: pointer;
            font-family: 'Courier New', Courier, monospace; box-sizing: border-box;
        }
        .model-action-btn:hover { background-color: rgba(255, 255, 255, 0.5); }
        
        /* START: Chemistry Propulsion Styles */
        #chemistry-panel {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 325px;
            left: 10px;
            width: var(--chem-panel-width); box-sizing: border-box;
            padding: 15px; background: rgba(0,0,0,0.7);
            border-radius: 5px; border: 1px solid rgba(255,255,255,0.2);
            max-height: calc(100vh - 400px); overflow-y: auto; display: none;
            z-index: 10;
        }
        .chem-section {
            margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
        }
        .chem-section:last-child { border-bottom: none; }
        .chem-section h3, .chem-section h4 {
            margin: 0 0 10px 0; font-size: 1em; color: #ddd;
        }
        .chem-input-group {
            display: grid; grid-template-columns: auto 1fr;
            gap: 8px 10px; font-size: 0.85em; align-items: center;
        }
        .chem-input-group label { text-align: right; color: #aaa; }
        .chem-input-group input, .chem-input-group .output-span {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; font-family: 'Courier New', Courier, monospace;
            padding: 4px; border-radius: 3px; width: 100%; box-sizing: border-box;
        }
        .chem-input-group .output-span { background: transparent; border-color: transparent; padding-left: 0;}
        .dim-input-group { grid-column: 2; display: flex; gap: 4px; }
        .dim-input-group input { text-align: center; }
        .valve-control-group { grid-column: 2; display: flex; align-items: center; gap: 8px; }
        .valve-control-group input[type=range] { flex-grow: 1; }
        .valve-control-group input[type=number] { width: 60px; }

        .propellant-group {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px; padding: 10px; margin-bottom: 10px;
        }
        .propellant-group-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .propellant-group-header input { width: 70%; }
        .remove-group-btn {
            background: #800; color: white; border: 1px solid #c00;
            border-radius: 50%; width: 22px; height: 22px;
            cursor: pointer; line-height: 20px; text-align: center;
        }
        #chem-thrust-container {
            width: 50%; display: none; justify-content: space-around;
            align-items: flex-end; pointer-events: all;
        }
        .chem-slider-wrapper { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .chem-slider {
            -webkit-appearance: none; appearance: none; width: 150px; height: 15px;
            background: rgba(255, 255, 255, 0.2); outline: none; border-radius: 10px;
            transform: rotate(-90deg); cursor: pointer; margin-bottom: 60px;
        }
        .chem-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 25px; height: 25px; border-radius: 50%;
        }
        #chem-oxi-slider::-webkit-slider-thumb { background: rgba(100, 150, 255, 0.8); }
        #chem-fuel-slider::-webkit-slider-thumb { background: rgba(255, 100, 100, 0.8); }
        #chem-master-slider::-webkit-slider-thumb { background: rgba(255, 255, 255, 0.8); }
        /* END: Chemistry Propulsion Styles */

        #upload-container {
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; text-align: center;
             z-index: 20;
        }
        #initial-flip-container {
            margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        #load-default-btn, #load-default-btn2, #load-default-btn3, #add-group-btn {
            margin-top: 15px; padding: 8px 16px; cursor: pointer; background-color: #444;
            color: white; border: 1px solid #666; border-radius: 5px;
        }
        #load-default-btn:hover, #load-default-btn2:hover, #load-default-btn3:hover, #add-group-btn:hover { background-color: #555; }
        
        #view-controls {
            position: absolute; top: 10px; right: 10px; display: flex;
            align-items: center; gap: 10px; pointer-events: all;
            z-index: 10;
        }
        #fpv-toggle, .gizmo-btn {
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.4);
            cursor: pointer; display: flex; justify-content: center;
            align-items: center; color: white;
        }
        #fpv-toggle { width: 40px; height: 40px; border-radius: 5px; font-size: 10px; }
        #fpv-toggle:hover, .gizmo-btn:hover { background: rgba(255,255,255,0.3); }
        
        #view-gizmo { display: grid; grid-template-columns: 25px 25px 25px; grid-template-rows: 25px 25px 25px; gap: 2px; }
        .gizmo-btn { font-size: 10px; user-select: none; }
        #gizmo-top { grid-column: 2; grid-row: 1; }
        #gizmo-left { grid-column: 1; grid-row: 2; }
        #gizmo-persp { grid-column: 2; grid-row: 2; }
        #gizmo-right { grid-column: 3; grid-row: 2; }
        #gizmo-front { grid-column: 2; grid-row: 3; }
    </style>
</head>
<body>

    <canvas id="threejs-canvas"></canvas>

    <div id="info-panel">
         <div>
           <img src="https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/templates/mn.png" alt="Mantis Navigation Logo" width="200" height="200" style="display: block; margin: 0 auto 5px auto;"><br><br>
            <span id="camera-mode-info">View: Follow</span><br>
            <span id="velocity-info">Velocity: (0, 0, 0)</span><br>
            <span id="thrust-info">Thrust: 0%</span>
        </div>
        <button id="reset-position-btn" class="model-action-btn" title="Reset drone to starting position">Return to Origin</button>
        <button id="change-model-btn" class="model-action-btn">Change Model</button>
        <button id="chem-propulsion-btn" class="model-action-btn">Chemistry Propulsion</button>
    </div>

    <div id="chemistry-panel">
        <div id="model-settings-container" class="chem-section">
            <h3>Model Settings</h3>
            <div class="chem-input-group">
                <label for="model-mass">Mass (kg):</label> <input type="number" id="model-mass" value="1.0">
                <label>Dims (in):</label>
                <div class="dim-input-group">
                    <input type="number" class="dim-input dim-x" placeholder="X" value="12.4">
                    <input type="number" class="dim-input dim-y" placeholder="Y" value="12.4">
                    <input type="number" class="dim-input dim-z" placeholder="Z" value="12.4">
                </div>
                <label>Volume (in³):</label> <span class="output-span volume-output">0</span>
                <label>Surf. Area (in²):</label> <span class="output-span surface-area-output">0</span>
                <!-- The following model physics are not part of the new propellant calculations -->
                <label>Internal Pressure (PSI):</label> <input type="number" class="pressure-input" value="0">
                <label>ATM Pressure (PSI):</label> <input type="number" class="atm-pressure-input" value="14.7">
                <label>Total Press.:</label> <span class="output-span total-pressure-output">0</span>
            </div>
        </div>
        <div id="propellant-groups-container">
             <h3>Propellant Groups</h3>
             <div id="propellant-groups-list"></div>
             <button id="add-group-btn" style="width:100%; margin-top: 5px;">+ Add Group</button>
        </div>
    </div>
    
    <template id="propellant-group-template">
        <div class="propellant-group">
            <div class="propellant-group-header">
                <input type="text" class="group-name-input" value="Group Name">
                <button class="remove-group-btn">-</button>
            </div>
            
            <!-- Oxidizer Section -->
            <div class="chem-section prop-section" data-prop-type="oxidizer" style="padding-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.2);">
                 <h4>Oxidizer</h4>
                 <div class="chem-input-group">
                    <label>Mass (g/in³):</label> <input type="number" class="mass-g-per-in3" value="0.041" step="0.001">
                    <label>Dims (in):</label>
                    <div class="dim-input-group">
                        <input type="number" class="dim-input dim-x" placeholder="X" value="10">
                        <input type="number" class="dim-input dim-y" placeholder="Y" value="10">
                        <input type="number" class="dim-input dim-z" placeholder="Z" value="10">
                    </div>
                    <label>Volume (in³):</label> <span class="output-span volume-output">0</span>
                    <label>Total Mass (g):</label> <span class="output-span total-mass-output">0</span>
                    <label>Density (Multiplier):</label> <input type="number" class="density-multiplier" value="1.0" step="0.01">
                    <label>Effective Mass (g):</label> <span class="output-span effective-mass-output">0</span>
                    <label>Temp. (°F):</label> <input type="number" class="prop-temp" value="-297">
                    <label>Internal Pressure (PSI):</label> <input type="number" class="pressure-input" value="2500">
                    <label>ATM Pressure (PSI):</label> <input type="number" class="atm-pressure-input" value="14.7">
                    <label>Total Press.:</label> <span class="output-span total-pressure-output">0</span>
                    <label>Valve Angle:</label>
                    <div class="valve-control-group">
                         <input type="range" class="valve-angle-slider" min="0" max="180" value="90">
                         <input type="number" class="valve-angle-input" min="0" max="180" value="90">
                    </div>
                    <label>Max Flow (lbs):</label> <input type="number" class="max-flow-input" value="5000">
                 </div>
            </div>
            <!-- Fuel Section -->
             <div class="chem-section prop-section" data-prop-type="fuel" style="border-bottom:none; padding-bottom:0; margin-bottom: 10px;">
                 <h4>Fuel</h4>
                 <div class="chem-input-group">
                    <label>Mass (g/in³):</label> <input type="number" class="mass-g-per-in3" value="0.030" step="0.001">
                    <label>Dims (in):</label>
                    <div class="dim-input-group">
                        <input type="number" class="dim-input dim-x" placeholder="X" value="10">
                        <input type="number" class="dim-input dim-y" placeholder="Y" value="10">
                        <input type="number" class="dim-input dim-z" placeholder="Z" value="10">
                    </div>
                    <label>Volume (in³):</label> <span class="output-span volume-output">0</span>
                    <label>Total Mass (g):</label> <span class="output-span total-mass-output">0</span>
                    <label>Density (Multiplier):</label> <input type="number" class="density-multiplier" value="1.0" step="0.01">
                    <label>Effective Mass (g):</label> <span class="output-span effective-mass-output">0</span>
                    <label>Temp. (°F):</label> <input type="number" class="prop-temp" value="77">
                    <label>Internal Pressure (PSI):</label> <input type="number" class="pressure-input" value="2500">
                    <label>ATM Pressure (PSI):</label> <input type="number" class="atm-pressure-input" value="14.7">
                    <label>Total Press.:</label> <span class="output-span total-pressure-output">0</span>
                    <label>Valve Angle:</label>
                    <div class="valve-control-group">
                         <input type="range" class="valve-angle-slider" min="0" max="180" value="90">
                         <input type="number" class="valve-angle-input" min="0" max="180" value="90">
                    </div>
                    <label>Max Flow (lbs):</label> <input type="number" class="max-flow-input" value="5000">
                 </div>
            </div>
            <!-- Group Combined Output -->
            <label style="font-size: 0.85em; color: #aaa;">Combined Temp:</label> <span class="output-span group-temp-output" style="font-size: 0.85em;">0 °F</span>
        </div>
    </template>

    <div id="upload-container">
        <h2>Upload Navigation Model</h2>
        <p>Please select a .glb or .gltf file.</p>
        <input type="file" id="model-upload" accept=".glb, .gltf">
        <div id="initial-flip-container">
            <input type="checkbox" id="initial-flip-checkbox">
            <label for="initial-flip-checkbox">Flip Model 180° on Load</label>
        </div>
        <br>
        <button id="load-default-btn">Load | ArielNPU</button>
        <br>
        <button id="load-default-btn2">Load | Arrow</button>
        <button id="load-default-btn3">Load | Ariel & Mantis Gimbal</button>
    </div>

    <div id="view-controls" style="display: none;">
        <div id="fpv-toggle" title="Toggle First-Person View">FPV</div>
        <div id="view-gizmo">
            <div class="gizmo-btn" id="gizmo-top" title="Top View">T</div>
            <div class="gizmo-btn" id="gizmo-left" title="Left View">L</div>
            <div class="gizmo-btn" id="gizmo-persp" title="Perspective View">P</div>
            <div class="gizmo-btn" id="gizmo-right" title="Right View">R</div>
            <div class="gizmo-btn" id="gizmo-front" title="Front View">F</div>
        </div>
    </div>

    <div id="ui-container" style="display: none;">
        <div class="control-area">
            <div id="joystick-base">
                <div id="joystick-stick"></div>
            </div>
        </div>
        <div class="control-area">
            <div id="thrust-container">
                <label for="thrust-slider">Altitude</label>
                <input type="range" min="0" max="100" value="0" id="thrust-slider">
                <button id="idle-button" title="Set altitude to hover">Idle</button>
            </div>
            <div id="chem-thrust-container">
                <div class="chem-slider-wrapper">
                    <label for="chem-oxi-slider">Oxi. Flow</label>
                    <input type="range" min="0" max="100" value="50" id="chem-oxi-slider" class="chem-slider">
                </div>
                 <div class="chem-slider-wrapper">
                    <label for="chem-fuel-slider">Fuel Flow</label>
                    <input type="range" min="0" max="100" value="50" id="chem-fuel-slider" class="chem-slider">
                </div>
                 <div class="chem-slider-wrapper">
                    <label for="chem-master-slider">Master Flow</label>
                    <input type="range" min="0" max="100" value="0" id="chem-master-slider" class="chem-slider">
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 100000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('threejs-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // =================== NEW MANIPULATABLE BACKGROUND (V2 - WITH TEXTURE ZOOM) ===================
        const backgroundScale = 1; 
        const backgroundRotationX = 1;
        const backgroundRotationY = 1.5;
        const backgroundRotationZ = 0;
        const textureZoom = 0.65;
        const texturePanX = 0;
        const texturePanY = 0.4;
        let skybox;
        const textureLoader = new THREE.TextureLoader();
        const backgroundFileUrl = 'https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/templates/2.png';
        textureLoader.load(backgroundFileUrl, (texture) => {
            const skyboxGeometry = new THREE.SphereGeometry(6000, 60, 40);
            texture.mapping = THREE.EquirectangularReflectionMapping;
            texture.colorSpace = THREE.SRGBColorSpace;
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            const skyboxMaterial = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.BackSide
            });
            skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterial);
            scene.add(skybox);
            console.log("Image skybox sphere created with texture controls.");
        });

        function updateSkybox() {
            if (skybox) {
                skybox.scale.set(backgroundScale, backgroundScale, backgroundScale);
                skybox.rotation.set(backgroundRotationX, backgroundRotationY, backgroundRotationZ);
                const texture = skybox.material.map;
                if (texture) {
                    const repeatX = 1 / textureZoom;
                    const repeatY = 1 / textureZoom;
                    texture.repeat.set(repeatX, repeatY);
                    const offsetX = (1 - repeatX) / 2 + texturePanX;
                    const offsetY = (1 - repeatY) / 2 + texturePanY;
                    texture.offset.set(offsetX, offsetY);
                }
            }
        }
        // ================= END OF NEW BACKGROUND LOADER ===================

        // --- LIGHTING & ENVIRONMENT ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);
        scene.add(new THREE.GridHelper(200, 50));
        const ground = new THREE.Mesh( new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.9 }) );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // --- UI ELEMENTS ---
        const uploadContainer = document.getElementById('upload-container');
        const uiContainer = document.getElementById('ui-container');
        const viewControls = document.getElementById('view-controls');
        const modelUploadInput = document.getElementById('model-upload');
        const changeModelBtn = document.getElementById('change-model-btn');
        const loadDefaultBtn = document.getElementById('load-default-btn');
        const loadDefaultBtn2 = document.getElementById('load-default-btn2');
        const loadDefaultBtn3 = document.getElementById('load-default-btn3');
        const joystickBase = document.getElementById('joystick-base');
        const joystickStick = document.getElementById('joystick-stick');
        const thrustSlider = document.getElementById('thrust-slider');
        const idleButton = document.getElementById('idle-button');
        const fpvToggle = document.getElementById('fpv-toggle');
        const gizmoContainer = document.getElementById('view-gizmo');
        const cameraModeInfo = document.getElementById('camera-mode-info');
        const resetPositionBtn = document.getElementById('reset-position-btn');
        const initialFlipCheckbox = document.getElementById('initial-flip-checkbox');
        const infoPanel = document.getElementById('info-panel');
        const chemPropulsionBtn = document.getElementById('chem-propulsion-btn');
        const chemistryPanel = document.getElementById('chemistry-panel');
        const thrustContainer = document.getElementById('thrust-container');
        const chemThrustContainer = document.getElementById('chem-thrust-container');
        const propellantGroupsList = document.getElementById('propellant-groups-list');
        const propellantGroupTemplate = document.getElementById('propellant-group-template');
        const chemOxiSlider = document.getElementById('chem-oxi-slider');
        const chemFuelSlider = document.getElementById('chem-fuel-slider');
        const chemMasterSlider = document.getElementById('chem-master-slider');

        // --- MODEL & PHYSICS VARIABLES ---
        let drone, modelMesh;
        const loader = new GLTFLoader();
        const physics = {
            velocity: new THREE.Vector3(),
            baseGravity: 0.015,
            drag: 0.98,
            lift: 0,
            baseMaxLift: 0.03,
            thrustPower: 0.01,
            yawSpeed: 0.1,
            liftScalar: 0.000005 // UPDATED Scalar to tune the new physics formula
        };
        const controls = { joystick: { x: 0, y: 0 }, thrust: 0 };
        let cameraMode = 'follow', chemistryModeActive = false, groupCounter = 0;

        // --- CALCULATION & UPDATE FUNCTIONS ---
        // *** NEW: Rewritten function for new physics model ***
        function updateDerivedValues(container) {
            // Get dimensional inputs
            const dimX = parseFloat(container.querySelector('.dim-x')?.value) || 0;
            const dimY = parseFloat(container.querySelector('.dim-y')?.value) || 0;
            const dimZ = parseFloat(container.querySelector('.dim-z')?.value) || 0;
            
            // Calculate and display Volume and Surface Area
            const volume = dimX * dimY * dimZ;
            const surfaceArea = 2 * ((dimX * dimY) + (dimX * dimZ) + (dimY * dimZ));
            container.querySelector('.volume-output').textContent = volume.toFixed(2);
            if (container.querySelector('.surface-area-output')) {
                container.querySelector('.surface-area-output').textContent = surfaceArea.toFixed(2);
            }
            
            // Perform propellant physics calculations if applicable
            if (container.matches('.prop-section')) {
                const massPerVolume = parseFloat(container.querySelector('.mass-g-per-in3')?.value) || 0;
                const densityMultiplier = parseFloat(container.querySelector('.density-multiplier')?.value) || 0;

                const totalMass = massPerVolume * volume;
                const effectiveMass = totalMass * densityMultiplier;

                container.querySelector('.total-mass-output').textContent = totalMass.toFixed(2);
                container.querySelector('.effective-mass-output').textContent = effectiveMass.toFixed(2);
                
                // Store the final calculated value in a data attribute for fast access in the animation loop
                container.dataset.effectiveMass = effectiveMass; 
            }

            // Calculate pressure (for both model and propellants)
            const internalPsi = parseFloat(container.querySelector('.pressure-input')?.value) || 0;
            const atmPsi = parseFloat(container.querySelector('.atm-pressure-input')?.value) || 0;
            const totalPressure = internalPsi + atmPsi;
            if(container.querySelector('.total-pressure-output')) {
                container.querySelector('.total-pressure-output').textContent = totalPressure.toFixed(2);
            }

            // Update combined temp if it's a propellant group
            const group = container.closest('.propellant-group');
            if (group) {
                const tempOxi = parseFloat(group.querySelector('[data-prop-type="oxidizer"] .prop-temp')?.value) || 0;
                const tempFuel = parseFloat(group.querySelector('[data-prop-type="fuel"] .prop-temp')?.value) || 0;
                const combinedTemp = (tempOxi + tempFuel) / 2;
                group.querySelector('.group-temp-output').textContent = `${combinedTemp.toFixed(1)} °F`;
            }
        }
        
        // *** NEW: Updated event listener setup ***
        function setupInputListeners(container) {
            const selector = '.dim-input, .pressure-input, .atm-pressure-input, .prop-temp, .mass-g-per-in3, .density-multiplier';
            container.querySelectorAll(selector).forEach(input => {
                input.addEventListener('input', () => updateDerivedValues(container.matches('.prop-section') ? container : document.getElementById('model-settings-container')));
            });
            // Run once on setup
            updateDerivedValues(container);
        }

        // --- CORE FUNCTIONS ---
        function reinitializeDroneState() {
            if (!drone) return;
            physics.velocity.set(0, 0, 0);
            controls.thrust = 0;
            thrustSlider.value = 0;
            resetJoystick();
            drone.quaternion.identity();
            cameraMode = 'follow';
            const cameraOffset = new THREE.Vector3(0, 4, 10);
            cameraOffset.applyQuaternion(drone.quaternion);
            const cameraPosition = new THREE.Vector3().addVectors(drone.position, cameraOffset);
            camera.position.copy(cameraPosition);
            camera.lookAt(drone.position);
        }

        function initializeSceneWithModel(gltf, shouldFlipOnLoad) {
            if (drone) scene.remove(drone);
            drone = new THREE.Group();
            drone.position.set(0, 5, 0);
            modelMesh = gltf.scene;
            if (shouldFlipOnLoad) {
                modelMesh.rotateY(Math.PI);
            }
            drone.add(modelMesh);
            scene.add(drone);
            reinitializeDroneState();
            resetChemistryPanel();
            uploadContainer.style.display = 'none';
            uiContainer.style.display = 'flex';
            viewControls.style.display = 'flex';
            changeModelBtn.style.display = 'block';
            resetPositionBtn.style.display = 'block';
            chemPropulsionBtn.style.display = 'block';
        }
        
        // --- CHEMISTRY MODE FUNCTIONS ---
        function toggleChemistryMode() {
            chemistryModeActive = !chemistryModeActive;
            
            if (chemistryModeActive) {
                const infoPanelRect = infoPanel.getBoundingClientRect();
                chemistryPanel.style.top = `${infoPanelRect.bottom + 15}px`;
                chemistryPanel.style.display = 'block';
            } else {
                 chemistryPanel.style.display = 'none';
            }
            
            thrustContainer.style.display = chemistryModeActive ? 'none' : 'flex';
            chemThrustContainer.style.display = chemistryModeActive ? 'flex' : 'none';
            chemPropulsionBtn.style.background = chemistryModeActive ? 'rgba(100, 200, 100, 0.5)' : '';
            chemPropulsionBtn.textContent = chemistryModeActive ? 'Exit Chemistry' : 'Chemistry Propulsion';
        }

        function addPropellantGroup() {
            groupCounter++;
            const groupClone = propellantGroupTemplate.content.cloneNode(true);
            const groupDiv = groupClone.querySelector('.propellant-group');
            groupDiv.querySelector('.group-name-input').value = `Propellant ${groupCounter}`;
            groupDiv.querySelector('.remove-group-btn').addEventListener('click', () => groupDiv.remove());

            groupDiv.querySelectorAll('.prop-section').forEach(section => {
                // *** NEW: Use updated setup function ***
                setupInputListeners(section);

                const type = section.dataset.propType;
                const maxFlowInput = section.querySelector('.max-flow-input');
                const targetSlider = type === 'oxidizer' ? chemOxiSlider : chemFuelSlider;
                
                maxFlowInput.addEventListener('input', () => {
                    targetSlider.max = parseFloat(maxFlowInput.value) || 100;
                });
                targetSlider.max = parseFloat(maxFlowInput.value) || 100; // Set initial max

                const angleSlider = section.querySelector('.valve-angle-slider');
                const angleInput = section.querySelector('.valve-angle-input');
                angleSlider.addEventListener('input', () => angleInput.value = angleSlider.value);
                angleInput.addEventListener('input', () => angleSlider.value = angleInput.value);
            });
            
            propellantGroupsList.appendChild(groupClone);
        }
        
        function resetChemistryPanel() {
            const modelSettings = document.getElementById('model-settings-container');
            modelSettings.querySelectorAll('input').forEach(input => {
                if(input.type !== 'button' && input.defaultValue !== undefined) input.value = input.defaultValue;
            });
            updateDerivedValues(modelSettings); // Use simplified call
            
            propellantGroupsList.innerHTML = ''; 
            groupCounter = 0; 
            addPropellantGroup();
            
            chemOxiSlider.value = 50;
            chemFuelSlider.value = 50;
            chemMasterSlider.value = 0;

            if (chemistryModeActive) toggleChemistryMode();
        }

        // --- EVENT LISTENERS ---
        loadDefaultBtn.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/ArielNPU.glb', (gltf) => initializeSceneWithModel(gltf, true)));
        loadDefaultBtn2.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/Arrow.glb', (gltf) => initializeSceneWithModel(gltf, true)));
        loadDefaultBtn3.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/MantisGimbal.glb', (gltf) => initializeSceneWithModel(gltf, true)));

        changeModelBtn.addEventListener('click', () => {
            uploadContainer.style.display = 'block';
            uiContainer.style.display = 'none';
            viewControls.style.display = 'none';
            changeModelBtn.style.display = 'none';
            resetPositionBtn.style.display = 'none';
            chemPropulsionBtn.style.display = 'none';
            if (chemistryModeActive) toggleChemistryMode();
            chemistryPanel.style.display = 'none';
        });

        modelUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            loader.load(url, (gltf) => {
                initializeSceneWithModel(gltf, initialFlipCheckbox.checked);
                URL.revokeObjectURL(url);
            });
        });

        resetPositionBtn.addEventListener('click', () => {
            if (drone) {
                drone.position.set(0, 5, 0);
                reinitializeDroneState();
            }
        });

        chemPropulsionBtn.addEventListener('click', toggleChemistryMode);
        document.getElementById('add-group-btn').addEventListener('click', addPropellantGroup);
        document.addEventListener('DOMContentLoaded', resetChemistryPanel);

        // --- UI CONTROLS LOGIC ---
        let joystickActive = false;
        const handleJoystickMove = (x, y) => {
            const rect = joystickBase.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
            let dx = x - centerX; let dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDist = rect.width / 2;
            if (distance > maxDist) { dx = (dx / distance) * maxDist; dy = (dy / distance) * maxDist; }
            joystickStick.style.transform = `translate(${dx}px, ${dy}px)`;
            controls.joystick.x = dx / maxDist; controls.joystick.y = -dy / maxDist;
        };
        const resetJoystick = () => { joystickActive = false; joystickStick.style.transition = 'transform 0.2s'; joystickStick.style.transform = 'translate(0, 0)'; controls.joystick.x = 0; controls.joystick.y = 0; };
        joystickBase.addEventListener('mousedown', (e) => { joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mousemove', (e) => { if (joystickActive) handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mouseup', resetJoystick);
        joystickBase.addEventListener('touchstart', (e) => { e.preventDefault(); joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
        window.addEventListener('touchmove', (e) => { if (joystickActive) handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); });
        window.addEventListener('touchend', resetJoystick);
        
        thrustSlider.addEventListener('input', (e) => { controls.thrust = parseFloat(e.target.value) / 100.0; });
        idleButton.addEventListener('click', () => { 
            const idleThrust = physics.baseGravity / physics.baseMaxLift; 
            controls.thrust = idleThrust; 
            thrustSlider.value = idleThrust * 100; 
        });
        
        // Master Slider Delta-Based Control Logic (No changes needed, this logic is correct)
        let masterSliderDragState = { active: false, initialMaster: 0, initialOxi: 0, initialFuel: 0 };
        function startMasterDrag() {
            masterSliderDragState.active = true;
            masterSliderDragState.initialMaster = parseFloat(chemMasterSlider.value);
            masterSliderDragState.initialOxi = parseFloat(chemOxiSlider.value);
            masterSliderDragState.initialFuel = parseFloat(chemFuelSlider.value);
        }
        function endMasterDrag() { masterSliderDragState.active = false; }
        function onMasterDrag() {
            if (!masterSliderDragState.active) return;
            const currentMaster = parseFloat(chemMasterSlider.value);
            const delta = currentMaster - masterSliderDragState.initialMaster;
            const newOxi = masterSliderDragState.initialOxi + delta;
            const newFuel = masterSliderDragState.initialFuel + delta;
            chemOxiSlider.value = Math.min(chemOxiSlider.max, Math.max(0, newOxi.toFixed(2)));
            chemFuelSlider.value = Math.min(chemFuelSlider.max, Math.max(0, newFuel.toFixed(2)));
        }
        chemMasterSlider.addEventListener('mousedown', startMasterDrag);
        chemMasterSlider.addEventListener('touchstart', startMasterDrag);
        window.addEventListener('mouseup', endMasterDrag);
        window.addEventListener('touchend', endMasterDrag);
        chemMasterSlider.addEventListener('input', onMasterDrag);

        fpvToggle.addEventListener('click', () => { cameraMode = (cameraMode === 'fpv') ? 'follow' : 'fpv'; });
        gizmoContainer.addEventListener('click', (e) => { const id = e.target.id; if (id.startsWith('gizmo-')) { cameraMode = id.replace('gizmo-', ''); if (cameraMode === 'persp') cameraMode = 'follow'; } });

        // --- ANIMATION LOOP ---
        function animate() {
            updateSkybox();
            requestAnimationFrame(animate);
            if (drone) {
                // --- PHYSICS LOGIC ---
                if (chemistryModeActive) {
                    const modelMass = parseFloat(document.getElementById('model-mass').value) || 1;
                    const appliedGravity = physics.baseGravity * modelMass;
                    let totalForce = 0;

                    const firstGroup = propellantGroupsList.querySelector('.propellant-group');
                    if (firstGroup) {
                        // *** NEW: Updated function to get pre-calculated data ***
                        const getPropData = (type) => {
                            const section = firstGroup.querySelector(`[data-prop-type="${type}"]`);
                            return {
                                // Read the pre-calculated effective mass directly from the data attribute
                                effectiveMass: parseFloat(section.dataset.effectiveMass) || 0, 
                                psi: parseFloat(section.querySelector('.pressure-input').value) || 0,
                                angle: parseFloat(section.querySelector('.valve-angle-input').value) || 0,
                            };
                        };

                        const oxiData = getPropData('oxidizer');
                        const fuelData = getPropData('fuel');
                        
                        // *** NEW: Updated Physics Formula using Effective Mass ***
                        // ((effective_mass + psi - angle) * flow_percentage)
                        const potentialOxi = (oxiData.effectiveMass + oxiData.psi - oxiData.angle);
                        const potentialFuel = (fuelData.effectiveMass + fuelData.psi - fuelData.angle);
                        
                        const flowPercentOxi = (parseFloat(chemOxiSlider.value) / parseFloat(chemOxiSlider.max)) || 0;
                        const flowPercentFuel = (parseFloat(chemFuelSlider.value) / parseFloat(chemFuelSlider.max)) || 0;
                        
                        const forceOxi = potentialOxi * flowPercentOxi;
                        const forceFuel = potentialFuel * flowPercentFuel;

                        totalForce = forceOxi + forceFuel;
                    }
                    
                    physics.lift = totalForce * physics.liftScalar;
                    
                    document.getElementById('thrust-info').innerText = `Force: ${totalForce.toFixed(0)} | Lift: ${physics.lift.toFixed(4)}`;
                    physics.velocity.y -= appliedGravity;
                } else {
                    // Original simple physics
                    physics.lift = controls.thrust * physics.baseMaxLift;
                    document.getElementById('thrust-info').innerText = `Altitude: ${(controls.thrust * 100).toFixed(0)}%`;
                    physics.velocity.y -= physics.baseGravity;
                }
                
                // Universal physics (applied in both modes)
                physics.velocity.y += physics.lift;
                const yawRotation = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), -controls.joystick.x * physics.yawSpeed);
                drone.quaternion.multiplyQuaternions(yawRotation, drone.quaternion);
                const thrustVector = new THREE.Vector3(0, 0, -1).applyQuaternion(drone.quaternion).multiplyScalar(controls.joystick.y * physics.thrustPower);
                physics.velocity.add(thrustVector);
                physics.velocity.multiplyScalar(physics.drag);
                drone.position.add(physics.velocity);

                if (drone.position.y < 0.5) {
                    drone.position.y = 0.5;
                    physics.velocity.y = 0;
                }
                
                modelMesh.rotation.z = -controls.joystick.x * 0.5;
                modelMesh.rotation.x = -controls.joystick.y * 0.3;

                // --- CAMERA UPDATE LOGIC ---
                modelMesh.visible = (cameraMode !== 'fpv');
                switch (cameraMode) {
                    case 'fpv':
                        const fpvOffset = new THREE.Vector3(0, 0.2, -0.2).applyQuaternion(drone.quaternion);
                        camera.position.copy(new THREE.Vector3().addVectors(drone.position, fpvOffset));
                        camera.quaternion.copy(drone.quaternion);
                        break;
                    case 'top': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 20, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'front': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 2, drone.position.z + 15), 0.1); camera.lookAt(drone.position); break;
                    case 'left': camera.position.lerp(new THREE.Vector3(drone.position.x - 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'right': camera.position.lerp(new THREE.Vector3(drone.position.x + 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'follow':
                    default:
                        const cameraOffset = new THREE.Vector3(0, 4, 10).applyQuaternion(drone.quaternion);
                        camera.position.lerp(new THREE.Vector3().addVectors(drone.position, cameraOffset), 0.1);
                        camera.lookAt(drone.position);
                        break;
                }
            }

            // --- UI INFO UPDATE ---
            const horizontalVelocity = Math.sqrt(physics.velocity.x**2 + physics.velocity.z**2);
            document.getElementById('velocity-info').innerText = `Velocity: H:${horizontalVelocity.toFixed(2)} V:${physics.velocity.y.toFixed(2)}`;
            cameraModeInfo.innerText = `View: ${cameraMode.charAt(0).toUpperCase() + cameraMode.slice(1)}`;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>
</html>