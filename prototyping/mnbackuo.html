<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mantis Navigation</title>
    <style>
    :root {
        --chem-panel-width: 340px;
    }
    :root {
        --chem-panel-height: 1050px;
    }

    body {
        

            margin: 0;
            overflow: hidden;
            background-color: #111;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }
        #threejs-canvas {
            
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        #ui-container {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 80%;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }
        .control-area {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #joystick-base {
            width: 150px;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
            pointer-events: all;
        }
        #joystick-stick {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            top: 40px;
            left: 40px;
            cursor: grab;
        }
        #thrust-container {
            width: 100px;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            gap: 15px;
        }
        #thrust-slider {
            -webkit-appearance: none; appearance: none;
            width: 150px; height: 15px; background: rgba(255, 255, 255, 0.2);
            outline: none; border-radius: 10px; transform: rotate(-90deg);
            cursor: pointer; margin: 0;
        }
        #thrust-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 25px; height: 25px; background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
        }
        #idle-button {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; font-family: 'Courier New', Courier, monospace;
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            margin-top: 60px; transform: translateY(20px);
        }
        #info-panel {
            position: absolute; top: 10px; left: 10px;
            padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px;
            display: flex; flex-direction: column; gap: 8px; width: 290px;
            z-index: 10;
        }
        .model-action-btn {
            display: none; width: 100%; padding: 8px;
            background-color: rgba(255, 255, 255, 0.3); border: 1px solid rgba(255, 255, 255, 0.5);
            color: white; border-radius: 5px; cursor: pointer;
            font-family: 'Courier New', Courier, monospace; box-sizing: border-box;
        }
        .model-action-btn:hover { background-color: rgba(255, 255, 255, 0.5); }
        
        /* START: Chemistry Propulsion Styles */
        #chemistry-panel {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 280px; /* Adjusted */
            left: 45px;
            width: var(--chem-panel-width); box-sizing: border-box;
            height: var(--chem-panel-height); box-sizing: border-box;
            padding: 15px; background: rgba(0,0,0,0.7);
            border-radius: 5px; border: 1px solid rgba(255,255,255,0.2);
            max-height: calc(100vh - 850px); overflow-y: auto; display: none;
            z-index: 10;
        }
        .chem-section {
            margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
        }
        .chem-section:last-child { border-bottom: none; }
        .chem-section h3, .chem-section h4 {
            margin: 0 0 10px 0; font-size: 1em; color: #ddd;
        }
        .chem-input-group {
            display: grid; grid-template-columns: auto 1fr;
            gap: 8px 10px; font-size: 0.85em; align-items: center;
        }
        .chem-input-group label { text-align: right; color: #aaa; }
        .chem-input-group input, .chem-input-group .output-span {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; font-family: 'Courier New', Courier, monospace;
            padding: 4px; border-radius: 3px; width: 100%; box-sizing: border-box;
        }
        .chem-input-group .output-span { background: transparent; border-color: transparent; padding-left: 0;}
        .dim-input-group { grid-column: 2; display: flex; gap: 4px; }
        .dim-input-group input { text-align: center; }
        .valve-control-group { grid-column: 2; display: flex; align-items: center; gap: 8px; }
        .valve-control-group input[type=range] { flex-grow: 1; }
        .valve-control-group input[type=number] { width: 60px; }

        .propellant-group {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px; padding: 10px; margin-bottom: 10px;
        }
        .propellant-group-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .propellant-group-header input { width: 70%; }
        .remove-group-btn {
            background: #800; color: white; border: 1px solid #c00;
            border-radius: 50%; width: 22px; height: 22px;
            cursor: pointer; line-height: 20px; text-align: center;
        }
        #chem-thrust-container {
            width: 50%; display: none; justify-content: space-around;
            align-items: flex-end; pointer-events: all;
        }
        .chem-slider-wrapper { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .chem-slider {
            -webkit-appearance: none; appearance: none; width: 150px; height: 15px;
            background: rgba(255, 255, 255, 0.2); outline: none; border-radius: 10px;
            transform: rotate(-90deg); cursor: pointer; margin-bottom: 60px;
        }
        .chem-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 25px; height: 25px; border-radius: 50%;
        }
        #chem-oxi-slider::-webkit-slider-thumb { background: rgba(100, 150, 255, 0.8); }
        #chem-fuel-slider::-webkit-slider-thumb { background: rgba(255, 100, 100, 0.8); }
        #launch-btn {
            background: midnightblue; border: 1px solid deepskyblue; color: white;
            padding: 15px 25px; border-radius: 8px; cursor: pointer;
            font-family: 'Courier New', Courier, monospace; font-size: 1.1em;
            transition: background-color 0.2s, border-color 0.2s;
        }
        #launch-btn:hover { background: deepskyblue; }
        /* END: Chemistry Propulsion Styles */

        /* START: Panel & Drawer Styles */
/* --- In your /* START: Panel & Drawer Styles */ section --- */

#trajectories-panel {
    display: none; 
    position: absolute;
    top: 10px;
    
    /* MODIFICATION: Center the panel horizontally at the top */
    left: 50%;
    transform: translateX(-50%); /* This centers it perfectly */
    /* REMOVED: right: 10px; */

    transition: transform 0.4s ease-in-out;
    width: var(--chem-panel-width);
    box-sizing: border-box;
    padding: 15px;
    background: rgba(0,0,0,0.7);
    border-radius: 5px;
    border: 1px solid rgba(255,255,255,0.2);
    z-index: 100;
}

/* ... keep the existing h3, p, and other general panel styles ... */

.drawer-handle {
    position: absolute;
    /* REMOVED: top: 50%; transform: translateY(-50%) - we will override this */
    width: 20px; /* Base width */
    height: 60px; /* Base height */
    background-color: rgba(30, 30, 30, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.3);
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    line-height: 18px;
    color: #fff;
    user-select: none;
    z-index: 11;
}

/* ... keep .drawer-handle:hover and .left-panel-handle ... */

/* REMOVED: The old .right-panel-handle style */

/* ADDED: New style for the top panel's handle */
.top-panel-handle {
    /* Position at the bottom-center of the panel */
    top: auto; /* Unset the 'top' from the base class */
    bottom: -21px; /* (handle height + border) to place it just outside */
    left: 50%;
    
    /* Change shape to be a horizontal tab */
    width: 80px;
    height: 20px;

    /* Center it and round the correct corners */
    transform: translateX(-50%); /* Center horizontally */
    border-top: none;
    border-radius: 0; /* Reset all corners first */
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
}


#info-panel.minimized, #chemistry-panel.minimized {
    transform: translateX(calc(-100% - 10px)); /* slide left (no change here) */
}

#trajectories-panel.minimized {
   /* MODIFICATION: Animate vertically (translateY) instead of horizontally */
   /* It combines the centering with the vertical slide-out */
   transform: translateX(-50%) translateY(calc(-100% - 10px));
}

        #trajectories-panel h3 {
            margin: 0 0 10px 0; font-size: 1em; color: #ddd;
        }
        #trajectories-panel p {
            font-size: 0.85em; color: #aaa; margin: 0 0 15px 0;
        }


.drawer-handle {
    position: absolute;
    /* REMOVED: top: 50%; transform: translateY(-50%) - we will override this */
    width: 20px; /* Base width */
    height: 60px; /* Base height */
    background-color: rgba(30, 30, 30, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.3);
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    line-height: 18px;
    color: #fff;
    user-select: none;
    z-index: 11;
}
        .drawer-handle:hover {
            background-color: rgba(80, 80, 80, 0.6);
        }
        .left-panel-handle {
            right: -21px; /* width + border */
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            border-left: none;
        }
        .right-panel-handle {
            left: -21px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            border-right: none;
        }


#trajectories-panel {
    display: none; 
    position: absolute;
    top: 10px;
    
    /* MODIFICATION: Center the panel horizontally at the top */
    left: 65%;
    transform: translateX(-50%); /* This centers it perfectly */
    /* REMOVED: right: 10px; */

    transition: transform 0.4s ease-in-out;
    width: var(--chem-panel-width);
    box-sizing: border-box;
    padding: 15px;
    background: rgba(0,0,0,0.7);
    border-radius: 5px;
    border: 1px solid rgba(255,255,255,0.2);
    z-index: 100;
}

/* ... keep the existing h3, p, and other general panel styles ... */

.drawer-handle {
    position: absolute;
    /* REMOVED: top: 50%; transform: translateY(-50%) - we will override this */
    width: 20px; /* Base width */
    height: 60px; /* Base height */
    background-color: rgba(30, 30, 30, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.3);
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    line-height: 18px;
    color: #fff;
    user-select: none;
    z-index: 11;
}

/* ... keep .drawer-handle:hover and .left-panel-handle ... */

/* REMOVED: The old .right-panel-handle style */

/* ADDED: New style for the top panel's handle */
.top-panel-handle {
    /* Position at the bottom-center of the panel */
    top: auto; /* Unset the 'top' from the base class */
    bottom: -21px; /* (handle height + border) to place it just outside */
    left: 50%;
    
    /* Change shape to be a horizontal tab */
    width: 80px;
    height: 20px;

    /* Center it and round the correct corners */
    transform: translateX(-50%); /* Center horizontally */
    border-top: none;
    border-radius: 0; /* Reset all corners first */
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
}


#info-panel.minimized, #chemistry-panel.minimized {
    transform: translateX(calc(-100% - 10px)); /* slide left (no change here) */
}

#trajectories-panel.minimized {
   /* MODIFICATION: Animate vertically (translateY) instead of horizontally */
   /* It combines the centering with the vertical slide-out */
   transform: translateX(-50%) translateY(calc(-100% - 10px));
}
        #upload-container {
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; text-align: center;
             z-index: 20;
        }
        #initial-flip-container {
            margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        #load-default-btn, #load-default-btn2, #load-default-btn3, #add-group-btn {
            margin-top: 15px; padding: 8px 16px; cursor: pointer; background-color: #444;
            color: white; border: 1px solid #666; border-radius: 5px;
        }
        #load-default-btn:hover, #load-default-btn2:hover, #load-default-btn3:hover, #add-group-btn:hover { background-color: #555; }
        
        #view-controls {
            position: absolute; top: 10px; right: 10px; display: flex;
            align-items: center; gap: 10px; pointer-events: all;
            z-index: 10;
        }
        #fpv-toggle, .gizmo-btn {
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.4);
            cursor: pointer; display: flex; justify-content: center;
            align-items: center; color: white;
        }
        #fpv-toggle { width: 40px; height: 40px; border-radius: 5px; font-size: 10px; }
        #fpv-toggle:hover, .gizmo-btn:hover { background: rgba(255,255,255,0.3); }
        
        #view-gizmo { display: grid; grid-template-columns: 25px 25px 25px; grid-template-rows: 25px 25px 25px; gap: 2px; }
        .gizmo-btn { font-size: 10px; user-select: none; }
        #gizmo-top { grid-column: 2; grid-row: 1; }
        #gizmo-left { grid-column: 1; grid-row: 2; }
        #gizmo-persp { grid-column: 2; grid-row: 2; }
        #gizmo-right { grid-column: 3; grid-row: 2; }
        #gizmo-front { grid-column: 2; grid-row: 3; }
    </style>
</head>
<body>
    <canvas id="threejs-canvas"></canvas>
<div id="trajectories-panel">
    <!-- Changed class to 'top-panel-handle' and icon to an up/down arrow for clarity -->
    <div class="drawer-handle top-panel-handle">↕</div>
    <h3>Launch & Orbit Trajectories</h3>
    <div class="chem-section" style="border-bottom: none;">
        <p>Trajectory planning for engine burns.</p>
        <div class="chem-input-group">
            <label>Target Apoapsis (km):</label> <input type="number" value="100">
            <label>Target Periapsis (km):</label> <input type="number" value="100">
            <label>Inclination (°):</label> <input type="number" value="0">
            <label>Target Body:</label> <span class="output-span">Earth</span>
        </div>
        <button class="model-action-btn" style="display: block; margin-top: 15px;">Plan Maneuver</button>
    </div>
</div>
    <div id="info-panel">
         <div class="drawer-handle left-panel-handle">&#9776;</div>
         <div>
           <img src="https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/templates/mn.png" alt="Mantis Navigation Logo" width="200" height="200" style="display: block; margin: 0 auto 5px auto;"><br><br>
            <span id="camera-mode-info">View: Follow</span><br>
            <span id="velocity-info">Velocity: (0, 0, 0)</span><br>
            <span id="thrust-info">Thrust: 0%</span>
        </div>
        <button id="reset-position-btn" class="model-action-btn" title="Reset drone to starting position">Return to Origin</button>
        <button id="change-model-btn" class="model-action-btn">Change Model</button>
        <button id="chem-propulsion-btn" class="model-action-btn">Chemistry Propulsion</button>
    </div>

    <div id="chemistry-panel">
        <div class="drawer-handle left-panel-handle">&#9776;</div>
        <div id="model-settings-container" class="chem-section">
            <h3>Model Settings</h3>
            <div class="chem-input-group">
                <label>Mass parts/in³:</label> <input type="number" class="mass-parts-input" value="1000">
                   <label>Dims (in):</label>
                <div class="dim-input-group">
                    <input type="number" class="dim-input dim-x" placeholder="X" value="12.4">
                    <input type="number" class="dim-input dim-y" placeholder="Y" value="12.4">
                    <input type="number" class="dim-input dim-z" placeholder="Z" value="12.4">
                </div>
                                <label>Volume (in³):</label> <span class="output-span volume-output">0</span>
                <label>Surf. Area (in²):</label> <span class="output-span surface-area-output">0</span>
              
                <label>Weight/part (g):</label> <input type="number" class="weight-per-part-input" value="0.01">
             
  <label>Density:</label> <input type="number" class="density-input" value="1.225">
                <label>Total weight (lbs):</label> <span class="output-span total-weight-output">0</span>
                <label>Pressure (PSI):</label> <input type="number" class="pressure-input" value="0">
                <label>ATM Press.:</label> <input type="number" class="atm-pressure-input" value="14.7">
                <label>Total Press.:</label> <span class="output-span total-pressure-output">0</span>
            </div>
        </div>
        <div id="depressurization-chamber-section" class="chem-section">
            <h3>Depressurization Chamber</h3>
            <div class="chem-input-group">
                <label>Mass parts/in³:</label> <input type="number" class="mass-parts-input" value="10">
   <label>Dims (in):</label>
                <div class="dim-input-group">
                    <input type="number" class="dim-input dim-x" placeholder="X" value="5">
                    <input type="number" class="dim-input dim-y" placeholder="Y" value="5">
                    <input type="number" class="dim-input dim-z" placeholder="Z" value="5">
                </div>
                <label>Volume (in³):</label> <span class="output-span volume-output">0</span>
                                <label>Weight/part (g):</label> <input type="number" class="weight-per-part-input" value="0.01">
             
                <label>Density:</label> <input type="number" class="density-input" value="1.0">
                <label>Total weight (lbs):</label> <span class="output-span total-weight-output">0</span>
                <label>Pressure (PSI):</label> <input type="number" class="pressure-input" value="0">
                <label>ATM Press.:</label> <input type="number" class="atm-pressure-input" value="14.7">
                <label>Total Press.:</label> <span class="output-span total-pressure-output">0</span>
            </div>
        </div>
        <div id="propellant-groups-container">
             <h3>Propellant Groups</h3>
             <div id="propellant-groups-list"></div>
             <button id="add-group-btn" style="width:100%; margin-top: 5px;">+ Add Group</button>
        </div>
    </div>
    
        

    <template id="propellant-group-template">
        <div class="propellant-group">
            <div class="propellant-group-header">
                <input type="text" class="group-name-input" value="Group Name">
                <button class="remove-group-btn">-</button>
            </div>
            
            <!-- Oxidizer Section -->
            <div class="chem-section prop-section" data-prop-type="oxidizer" style="padding-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.2);">
                 <h4>Oxidizer</h4>
                 <div class="chem-input-group">
                    <label>Mass parts/in³:</label> <input type="number" class="mass-parts-input" value="2000">
    <label>Dims (in):</label>
                    <div class="dim-input-group">
                        <input type="number" class="dim-input dim-x" placeholder="X" value="100">
                        <input type="number" class="dim-input dim-y" placeholder="Y" value="100">
                        <input type="number" class="dim-input dim-z" placeholder="Z" value="180">
                    </div>
                    <label>Volume (in³):</label> <span class="output-span volume-output">0</span>
                    <label>Surf. Area (in²):</label> <span class="output-span surface-area-output">0</span>
                                        <label>Weight/part (g):</label> <input type="number" class="weight-per-part-input" value="1.0">
                
                    <label>Density:</label> <input type="number" class="density-input" value="1.24">
                    <label>Total weight (lbs):</label> <span class="output-span total-weight-output">0</span>
                    <label>Temp. (°F):</label> <input type="number" class="temp-input" value="-297">
                    <label>Pressure (PSI):</label> <input type="number" class="pressure-input" value="2500">
                    <label>ATM Press.:</label> <input type="number" class="atm-pressure-input" value="14.7">
                    <label>Total Press.:</label> <span class="output-span total-pressure-output">0</span>
                    <label>Valve Angle:</label>
                    <div class="valve-control-group">
                         <input type="range" class="valve-angle-slider" min="0" max="180" value="90">
                         <input type="number" class="valve-angle-input" min="0" max="180" value="90">
                    </div>
                    <label>Max Flow (lbs):</label> <input type="number" class="max-flow-input" value="45000">
                 </div>
            </div>
            <!-- Fuel Section -->
             <div class="chem-section prop-section" data-prop-type="fuel" style="border-bottom:none; padding-bottom:0; margin-bottom: 10px;">
                 <h4>Fuel</h4>
                 <div class="chem-input-group">
                    <label>Mass parts/in³:</label> <input type="number" class="mass-parts-input" value="1900">
        <label>Dims (in):</label>
                    <div class="dim-input-group">
                        <input type="number" class="dim-input dim-x" placeholder="X" value="100">
                        <input type="number" class="dim-input dim-y" placeholder="Y" value="100">
                        <input type="number" class="dim-input dim-z" placeholder="Z" value="77.5">
                    </div>
                    <label>Volume (in³):</label> <span class="output-span volume-output">0</span>
                    <label>Surf. Area (in²):</label> <span class="output-span surface-area-output">0</span>
                                        <label>Weight/part (g):</label> <input type="number" class="weight-per-part-input" value="1.0">
            
                    <label>Density:</label> <input type="number" class="density-input" value="1.15">
                    <label>Total weight (lbs):</label> <span class="output-span total-weight-output">0</span>
                    <label>Temp. (°F):</label> <input type="number" class="temp-input" value="77">
                    <label>Pressure (PSI):</label> <input type="number" class="pressure-input" value="130">
                    <label>ATM Press.:</label> <input type="number" class="atm-pressure-input" value="14.7">
                    <label>Total Press.:</label> <span class="output-span total-pressure-output">0</span>
                    <label>Valve Angle:</label>
                    <div class="valve-control-group">
                         <input type="range" class="valve-angle-slider" min="0" max="180" value="90">
                         <input type="number" class="valve-angle-input" min="0" max="180" value="90">
                    </div>
                    <label>Max Flow (lbs):</label> <input type="number" class="max-flow-input" value="45000">
                 </div>
            </div>
            <!-- Group Combined Output -->
            <label style="font-size: 0.85em; color: #aaa;">Combined Temp:</label> <span class="output-span group-temp-output" style="font-size: 0.85em;">0 °F</span>
        </div>
        
    </template>

    <div id="upload-container">
        <h2>Upload Navigation Model</h2>
        <p>Please select a .glb or .gltf file.</p>
        <input type="file" id="model-upload" accept=".glb, .gltf">
        <div id="initial-flip-container">
            <input type="checkbox" id="initial-flip-checkbox">
            <label for="initial-flip-checkbox">Flip Model 180° on Load</label>
        </div>
        <br>
        <button id="load-default-btn">Load | ArielNPU</button>
        <br>
        <button id="load-default-btn2">Load | Arrow</button>
        <button id="load-default-btn3">Load | Ariel & Mantis Gimbal</button>
    </div>

    <div id="view-controls" style="display: none;">
        <div id="fpv-toggle" title="Toggle First-Person View">FPV</div>
        <div id="view-gizmo">
            <div class="gizmo-btn" id="gizmo-top" title="Top View">T</div>
            <div class="gizmo-btn" id="gizmo-left" title="Left View">L</div>
            <div class="gizmo-btn" id="gizmo-persp" title="Perspective View">P</div>
            <div class="gizmo-btn" id="gizmo-right" title="Right View">R</div>
            <div class="gizmo-btn" id="gizmo-front" title="Front View">F</div>
        </div>
    </div>

    <div id="ui-container" style="display: none;">
        <div class="control-area">
            <div id="joystick-base">
                <div id="joystick-stick"></div>
            </div>
        </div>
        <div class="control-area">
            <div id="thrust-container">
                <label for="thrust-slider">Altitude</label>
                <input type="range" min="0" max="100" value="0" id="thrust-slider">
                <button id="idle-button" title="Set altitude to hover">Idle</button>
            </div>
            <div id="chem-thrust-container">
                <div class="chem-slider-wrapper">
                    <label for="chem-oxi-slider">Oxi. Flow</label>
                    <input type="range" min="0" max="100" value="0" id="chem-oxi-slider" class="chem-slider">
                </div>
                 <div class="chem-slider-wrapper">
                    <label for="chem-fuel-slider">Fuel Flow</label>
                    <input type="range" min="0" max="100" value="0" id="chem-fuel-slider" class="chem-slider">
                </div>
                 <div class="chem-slider-wrapper">
                    <button id="launch-btn">Launch</button>
                </div>
            </div>
        </div>
    </div>




    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 100000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('threejs-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // --- BACKGROUND ---
        let skybox;
        const textureLoader = new THREE.TextureLoader();
        const backgroundFileUrl = 'https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/templates/2.png';
        textureLoader.load(backgroundFileUrl, (texture) => {
            const skyboxGeometry = new THREE.SphereGeometry(6000, 60, 40);
            texture.mapping = THREE.EquirectangularReflectionMapping;
            texture.colorSpace = THREE.SRGBColorSpace;
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            const skyboxMaterial = new THREE.MeshBasicMaterial({ map: texture, side: THREE.BackSide });
            skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterial);
            scene.add(skybox);
        });

        function updateSkybox() {
            if (skybox) {
                const backgroundScale = 1, backgroundRotationX = 1, backgroundRotationY = 1.5, backgroundRotationZ = 0;
                const textureZoom = 0.65, texturePanX = 0, texturePanY = 0.4;
                skybox.scale.set(backgroundScale, backgroundScale, backgroundScale);
                skybox.rotation.set(backgroundRotationX, backgroundRotationY, backgroundRotationZ);
                const texture = skybox.material.map;
                if (texture) {
                    const repeatX = 1 / textureZoom, repeatY = 1 / textureZoom;
                    texture.repeat.set(repeatX, repeatY);
                    const offsetX = (1 - repeatX) / 2 + texturePanX, offsetY = (1 - repeatY) / 2 + texturePanY;
                    texture.offset.set(offsetX, offsetY);
                }
            }
        }

        // --- LIGHTING & ENVIRONMENT ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);
        scene.add(new THREE.GridHelper(200, 50));
        const ground = new THREE.Mesh( new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.9 }) );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // --- UI ELEMENTS ---
        const uploadContainer = document.getElementById('upload-container');
        const uiContainer = document.getElementById('ui-container');
        const viewControls = document.getElementById('view-controls');
        const modelUploadInput = document.getElementById('model-upload');
        const changeModelBtn = document.getElementById('change-model-btn');
        const loadDefaultBtn = document.getElementById('load-default-btn');
        const loadDefaultBtn2 = document.getElementById('load-default-btn2');
        const loadDefaultBtn3 = document.getElementById('load-default-btn3');
        const joystickBase = document.getElementById('joystick-base');
        const joystickStick = document.getElementById('joystick-stick');
        const thrustSlider = document.getElementById('thrust-slider');
        const idleButton = document.getElementById('idle-button');
        const fpvToggle = document.getElementById('fpv-toggle');
        const gizmoContainer = document.getElementById('view-gizmo');
        const cameraModeInfo = document.getElementById('camera-mode-info');
        const resetPositionBtn = document.getElementById('reset-position-btn');
        const initialFlipCheckbox = document.getElementById('initial-flip-checkbox');
        const infoPanel = document.getElementById('info-panel');
        const chemPropulsionBtn = document.getElementById('chem-propulsion-btn');
        const chemistryPanel = document.getElementById('chemistry-panel');
        const trajectoriesPanel = document.getElementById('trajectories-panel');
        const thrustContainer = document.getElementById('thrust-container');
        const chemThrustContainer = document.getElementById('chem-thrust-container');
        const propellantGroupsList = document.getElementById('propellant-groups-list');
        const propellantGroupTemplate = document.getElementById('propellant-group-template');
        const chemOxiSlider = document.getElementById('chem-oxi-slider');
        const chemFuelSlider = document.getElementById('chem-fuel-slider');
        const launchBtn = document.getElementById('launch-btn');


        // --- MODEL & PHYSICS VARIABLES ---
        let drone, modelMesh;
        const loader = new GLTFLoader();
        const physics = {
            velocity: new THREE.Vector3(),
            baseGravity: 0.00003, // Base gravity factor, will be multiplied by dynamic mass
            drag: 0.98,
            lift: 0,
            baseMaxLift: 0.03,
            thrustPower: 0.01,
            yawSpeed: 0.1,
            liftScalar: 0.000001 // Scalar to tune the chemistry physics formula
        };
        const controls = { joystick: { x: 0, y: 0 }, thrust: 0 };
        let cameraMode = 'follow', chemistryModeActive = false, groupCounter = 0, isLaunched = false;

        // --- CALCULATION & UPDATE FUNCTIONS ---
        function updateDerivedValues(container) {
            // Standard calculations
            const dimX = parseFloat(container.querySelector('.dim-x')?.value) || 0;
            const dimY = parseFloat(container.querySelector('.dim-y')?.value) || 0;
            const dimZ = parseFloat(container.querySelector('.dim-z')?.value) || 0;
            const psi = parseFloat(container.querySelector('.pressure-input')?.value) || 0;
            const atmPsi = parseFloat(container.querySelector('.atm-pressure-input')?.value) || 0;
            
            const volume = dimX * dimY * dimZ;
            const surfaceArea = 2 * ((dimX * dimY) + (dimX * dimZ) + (dimY * dimZ));
            const totalPressure = psi + atmPsi;

            container.querySelector('.volume-output').textContent = volume.toFixed(2);
            if(container.querySelector('.surface-area-output')) {
                container.querySelector('.surface-area-output').textContent = surfaceArea.toFixed(2);
            }
            if(container.querySelector('.total-pressure-output')) {
                container.querySelector('.total-pressure-output').textContent = totalPressure.toFixed(2);
            }
            
            // New weight calculation based on mockup formula
            const massPartsInput = container.querySelector('.mass-parts-input');
            const weightPerPartInput = container.querySelector('.weight-per-part-input');
            const densityInput = container.querySelector('.density-input');
            const totalWeightOutput = container.querySelector('.total-weight-output');

            if (massPartsInput && weightPerPartInput && densityInput && totalWeightOutput) {
                const massParts = parseFloat(massPartsInput.value) || 0;
                const weightPerPartG = parseFloat(weightPerPartInput.value) || 0;
                const density = parseFloat(densityInput.value) || 1; // Avoid division by zero
                
                // Formula: (Mass Parts/in³ * Weight/part (g) * Volume) / Density -> Total Grams
                const totalGrams = (massParts * weightPerPartG * volume) / density;
                
                // Convert grams to pounds (1 lb = 453.592 g)
                const totalLbs = totalGrams / 453.592;
                totalWeightOutput.textContent = totalLbs.toFixed(4);
            }


            // Update combined temp if it's a propellant group
            const group = container.closest('.propellant-group');
            if (group) {
                const tempOxi = parseFloat(group.querySelector('[data-prop-type="oxidizer"] .temp-input')?.value) || 0;
                const tempFuel = parseFloat(group.querySelector('[data-prop-type="fuel"] .temp-input')?.value) || 0;
                const combinedTemp = (tempOxi + tempFuel) / 2;
                group.querySelector('.group-temp-output').textContent = `${combinedTemp.toFixed(1)} °F`;
            }
        }

        function setupInputListeners(container) {
            container.querySelectorAll('.dim-input, .pressure-input, .atm-pressure-input, .temp-input, .mass-parts-input, .weight-per-part-input, .density-input').forEach(input => {
                input.addEventListener('input', () => updateDerivedValues(container));
            });
            if (container.classList.contains('propellant-group')) {
                 container.querySelectorAll('.prop-section').forEach(section => setupInputListeners(section));
            } else {
                 updateDerivedValues(container);
            }
        }

        // --- CORE FUNCTIONS ---
        function reinitializeDroneState() {
            if (!drone) return;
            physics.velocity.set(0, 0, 0);
            controls.thrust = 0;
            thrustSlider.value = 0;
            resetJoystick();
            drone.quaternion.identity();
            cameraMode = 'follow';
            const cameraOffset = new THREE.Vector3(0, 4, 10);
            cameraOffset.applyQuaternion(drone.quaternion);
            const cameraPosition = new THREE.Vector3().addVectors(drone.position, cameraOffset);
            camera.position.copy(cameraPosition);
            camera.lookAt(drone.position);
        }

        function initializeSceneWithModel(gltf, shouldFlipOnLoad) {
            if (drone) scene.remove(drone);
            drone = new THREE.Group();
            drone.position.set(0, 5, 0);
            modelMesh = gltf.scene;
            if (shouldFlipOnLoad) {
                modelMesh.rotateY(Math.PI);
            }
            drone.add(modelMesh);
            scene.add(drone);
            reinitializeDroneState();
            resetChemistryPanel(); // This also ensures chem mode is off by default
            uploadContainer.style.display = 'none';
            uiContainer.style.display = 'flex';
            viewControls.style.display = 'flex';
            changeModelBtn.style.display = 'block';
            resetPositionBtn.style.display = 'block';
            chemPropulsionBtn.style.display = 'block';

            // Ensure panels are not minimized on load
            document.querySelectorAll('#info-panel, #chemistry-panel, #trajectories-panel').forEach(p => p.classList.remove('minimized'));
        }
        
        // --- CHEMISTRY MODE FUNCTIONS ---
        function toggleChemistryMode() {
            chemistryModeActive = !chemistryModeActive;
            
            if (chemistryModeActive) {
                // Dynamically position chemistry panel below the info panel to prevent overlap
                const infoPanelRect = infoPanel.getBoundingClientRect();
                const topPosition = infoPanelRect.bottom + 10;
                chemistryPanel.style.top = `${topPosition}px`;
                // Dynamically set max-height to use available space and prevent being cut off
                chemistryPanel.style.maxHeight = `calc(100vh - ${topPosition}px - 20px)`; 

                chemistryPanel.style.display = 'flex';
                trajectoriesPanel.style.display = 'block';
            } else {
                 chemistryPanel.style.display = 'none';
                 trajectoriesPanel.style.display = 'none';
                 // If we exit chemistry mode while the engine is running, shut it down.
                 if (isLaunched) {
                    isLaunched = false;
                    launchBtn.textContent = 'Launch';
                    launchBtn.style.background = '#282';
                    launchBtn.style.borderColor = '#4c4';
                 }
            }
            
            thrustContainer.style.display = chemistryModeActive ? 'none' : 'flex';
            chemThrustContainer.style.display = chemistryModeActive ? 'flex' : 'none';
            chemPropulsionBtn.style.background = chemistryModeActive ? 'rgba(100, 200, 100, 0.5)' : '';
            chemPropulsionBtn.textContent = chemistryModeActive ? 'Exit Chemistry' : 'Chemistry Propulsion';
        }

        function addPropellantGroup() {
            groupCounter++;
            const groupClone = propellantGroupTemplate.content.cloneNode(true);
            const groupDiv = groupClone.querySelector('.propellant-group');
            groupDiv.querySelector('.group-name-input').value = `Propellant ${groupCounter}`;
            groupDiv.querySelector('.remove-group-btn').addEventListener('click', () => groupDiv.remove());

            groupDiv.querySelectorAll('.prop-section').forEach(section => {
                setupInputListeners(section);
                updateDerivedValues(section); // Initial calculation

                const angleSlider = section.querySelector('.valve-angle-slider');
                const angleInput = section.querySelector('.valve-angle-input');
                angleSlider.addEventListener('input', () => angleInput.value = angleSlider.value);
                angleInput.addEventListener('input', () => angleSlider.value = angleInput.value);
            });
            updateDerivedValues(groupDiv.querySelector('[data-prop-type="oxidizer"]'));
            updateDerivedValues(groupDiv.querySelector('[data-prop-type="fuel"]'));

            propellantGroupsList.appendChild(groupClone);
        }
        
        function resetChemistryPanel() {
            // Setup Model Settings
            const modelSettings = document.getElementById('model-settings-container');
            modelSettings.querySelectorAll('input').forEach(input => {
                if(input.type !== 'button' && input.defaultValue !== undefined) input.value = input.defaultValue;
            });
            setupInputListeners(modelSettings);
            updateDerivedValues(modelSettings);

            // Setup Depressurization Chamber
            const depressChamber = document.getElementById('depressurization-chamber-section');
            if (depressChamber) {
                depressChamber.querySelectorAll('input').forEach(input => {
                    if(input.type !== 'button' && input.defaultValue !== undefined) input.value = input.defaultValue;
                });
                setupInputListeners(depressChamber);
                updateDerivedValues(depressChamber);
            }

            // Setup Propellant Groups
            propellantGroupsList.innerHTML = ''; 
            groupCounter = 0; 
            addPropellantGroup();
            
            // Reset Sliders and Launch State
            chemOxiSlider.value = 0;
            chemFuelSlider.value = 0;
            isLaunched = false;
            launchBtn.textContent = 'Launch';
            launchBtn.style.background = '#282';
            launchBtn.style.borderColor = '#4c4';

            // Ensure chemistry mode is turned off if it was on
            if (chemistryModeActive) {
                toggleChemistryMode();
            }
        }

        // --- EVENT LISTENERS ---
        loadDefaultBtn.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/ArielNPU.glb', (gltf) => initializeSceneWithModel(gltf, true)));
        loadDefaultBtn2.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/Arrow.glb', (gltf) => initializeSceneWithModel(gltf, true)));
        loadDefaultBtn3.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/MantisGimbal.glb', (gltf) => initializeSceneWithModel(gltf, true)));

        changeModelBtn.addEventListener('click', () => {
            uploadContainer.style.display = 'block';
            uiContainer.style.display = 'none';
            viewControls.style.display = 'none';
            changeModelBtn.style.display = 'none';
            resetPositionBtn.style.display = 'none';
            chemPropulsionBtn.style.display = 'none';
            // Deactivate chem mode if it's active
            if (chemistryModeActive) {
                toggleChemistryMode();
            }
        });

        modelUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            loader.load(url, (gltf) => {
                initializeSceneWithModel(gltf, initialFlipCheckbox.checked);
                URL.revokeObjectURL(url);
            });
        });

        resetPositionBtn.addEventListener('click', () => {
            if (drone) {
                drone.position.set(0, 5, 0);
                reinitializeDroneState();
            }
        });

        chemPropulsionBtn.addEventListener('click', toggleChemistryMode);
        document.getElementById('add-group-btn').addEventListener('click', addPropellantGroup);
        
        // --- DRAWER LOGIC ---
        function setupDrawerHandles() {
            document.querySelectorAll('.drawer-handle').forEach(handle => {
                handle.addEventListener('click', () => {
                    handle.parentElement.classList.toggle('minimized');
                });
            });
        }
        setupDrawerHandles();

        document.addEventListener('DOMContentLoaded', resetChemistryPanel);

        // --- UI CONTROLS LOGIC ---
        let joystickActive = false;
        const handleJoystickMove = (x, y) => {
            const rect = joystickBase.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
            let dx = x - centerX; let dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDist = rect.width / 2;
            if (distance > maxDist) { dx = (dx / distance) * maxDist; dy = (dy / distance) * maxDist; }
            joystickStick.style.transform = `translate(${dx}px, ${dy}px)`;
            controls.joystick.x = dx / maxDist; controls.joystick.y = -dy / maxDist;
        };
        const resetJoystick = () => { joystickActive = false; joystickStick.style.transition = 'transform 0.2s'; joystickStick.style.transform = 'translate(0, 0)'; controls.joystick.x = 0; controls.joystick.y = 0; };
        joystickBase.addEventListener('mousedown', (e) => { joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mousemove', (e) => { if (joystickActive) handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mouseup', resetJoystick);
        joystickBase.addEventListener('touchstart', (e) => { e.preventDefault(); joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
        window.addEventListener('touchmove', (e) => { if (joystickActive) handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); });
        window.addEventListener('touchend', resetJoystick);
        
        thrustSlider.addEventListener('input', (e) => { controls.thrust = parseFloat(e.target.value) / 100.0; });
        idleButton.addEventListener('click', () => { 
            const idleThrust = (physics.baseGravity * 2.2) / physics.baseMaxLift; // Approximate idle
            controls.thrust = idleThrust; 
            thrustSlider.value = idleThrust * 100; 
        });

        // --- NEW LAUNCH BUTTON LOGIC ---
        launchBtn.addEventListener('click', () => {
            if (!chemistryModeActive) return; // Only works in chem mode

            isLaunched = !isLaunched; // Toggle the launch state

            if (isLaunched) {
                launchBtn.textContent = 'Shutdown';
                launchBtn.style.background = '#a22'; // Reddish for active
                launchBtn.style.borderColor = '#c44';
            } else {
                launchBtn.textContent = 'Launch';
                launchBtn.style.background = '#282'; // Back to green
                launchBtn.style.borderColor = '#4c4';
                physics.lift = 0; // Kill lift immediately on shutdown
            }
        });

        fpvToggle.addEventListener('click', () => { cameraMode = (cameraMode === 'fpv') ? 'follow' : 'fpv'; });
        gizmoContainer.addEventListener('click', (e) => { const id = e.target.id; if (id.startsWith('gizmo-')) { cameraMode = id.replace('gizmo-', ''); if (cameraMode === 'persp') cameraMode = 'follow'; } });
        
        // --- HELPER TO GET PROPELLANT DATA ---
        const getPropData = (type) => {
            const firstGroup = propellantGroupsList.querySelector('.propellant-group');
            if (!firstGroup) return null;
            const section = firstGroup.querySelector(`[data-prop-type="${type}"]`);
            if (!section) return null;

            const psi = parseFloat(section.querySelector('.pressure-input').value) || 0;
            const atmPsi = parseFloat(section.querySelector('.atm-pressure-input').value) || 0;
            return {
                density: parseFloat(section.querySelector('.density-input').value) || 1,
                angle: parseFloat(section.querySelector('.valve-angle-input').value) || 0,
                totalPressure: psi + atmPsi,
                maxFlow: parseFloat(section.querySelector('.max-flow-input').value) || Number.POSITIVE_INFINITY,
            };
        };

        // --- ANIMATION LOOP ---
        function animate() {
            updateSkybox();
            requestAnimationFrame(animate);
            if (drone) {
                // --- PHYSICS LOGIC ---
                if (chemistryModeActive) {
                    const modelWeightLbsText = document.querySelector('#model-settings-container .total-weight-output').textContent;
                    const modelWeightLbs = parseFloat(modelWeightLbsText) || 0;
                    const appliedGravity = physics.baseGravity * modelWeightLbs;
                    
                    let totalForce = 0;
                    if (isLaunched) { // Only calculate thrust if engine is ignited
                        const depressSection = document.getElementById('depressurization-chamber-section');
                        let depressTotalPressure = 0;
                        if (depressSection) {
                            const depressPsi = parseFloat(depressSection.querySelector('.pressure-input').value) || 0;
                            const depressAtmPsi = parseFloat(depressSection.querySelector('.atm-pressure-input').value) || 0;
                            depressTotalPressure = depressPsi + depressAtmPsi;
                        }

                        const oxiData = getPropData('oxidizer');
                        const fuelData = getPropData('fuel');
                        
                        if (oxiData && fuelData) {
                            const flowPercentOxi = (parseFloat(chemOxiSlider.value) / 100) || 0;
                            const flowPercentFuel = (parseFloat(chemFuelSlider.value) / 100) || 0;
                            
                            // 1. Calculate potential flow pressure, adding depressurization bonus
                            let oxiPotential = oxiData.totalPressure;
                            if (depressTotalPressure < oxiData.totalPressure) {
                                oxiPotential += (oxiData.totalPressure - depressTotalPressure);
                            }

                            let fuelPotential = fuelData.totalPressure;
                            if (depressTotalPressure < fuelData.totalPressure) {
                                fuelPotential += (fuelData.totalPressure - depressTotalPressure);
                            }

                            // 2. Apply panel valve angle as a gate/limiter (0-180 -> 0-1 scale)
                            const oxiValveGate = oxiData.angle / 180.0;
                            const fuelValveGate = fuelData.angle / 180.0;

                            // 3. Calculate force from potential, density, gates, and throttle sliders
                            let forceOxi = oxiPotential * oxiData.density * oxiValveGate * flowPercentOxi;
                            let forceFuel = fuelPotential * fuelData.density * fuelValveGate * flowPercentFuel;
                            
                            // 4. Cap the force by the Max Flow setting
                            forceOxi = Math.min(forceOxi, oxiData.maxFlow);
                            forceFuel = Math.min(forceFuel, fuelData.maxFlow);

                            // 5. Final force is the sum
                            totalForce = forceOxi + forceFuel;
                        }
                    }
                    
                    physics.lift = totalForce * physics.liftScalar;
                    document.getElementById('thrust-info').innerText = `Force: ${totalForce.toFixed(0)} | Lift: ${physics.lift.toFixed(4)}`;
                    physics.velocity.y -= appliedGravity;

                } else {
                    physics.lift = controls.thrust * physics.baseMaxLift;
                    document.getElementById('thrust-info').innerText = `Altitude: ${(controls.thrust * 100).toFixed(0)}%`;
                    physics.velocity.y -= (physics.baseGravity * 2.2); // Apply base gravity for simple mode
                }
                
                // Universal physics (applied in both modes)
                physics.velocity.y += physics.lift;
                const yawRotation = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), -controls.joystick.x * physics.yawSpeed);
                drone.quaternion.multiplyQuaternions(yawRotation, drone.quaternion);
                const thrustVector = new THREE.Vector3(0, 0, -1).applyQuaternion(drone.quaternion).multiplyScalar(controls.joystick.y * physics.thrustPower);
                physics.velocity.add(thrustVector);
                physics.velocity.multiplyScalar(physics.drag);
                drone.position.add(physics.velocity);

                if (drone.position.y < 0.5) {
                    drone.position.y = 0.5;
                    physics.velocity.y = 0;
                }
                
                modelMesh.rotation.z = -controls.joystick.x * 0.5;
                modelMesh.rotation.x = -controls.joystick.y * 0.3;

                // --- CAMERA UPDATE LOGIC ---
                modelMesh.visible = (cameraMode !== 'fpv');
                switch (cameraMode) {
                    case 'fpv':
                        const fpvOffset = new THREE.Vector3(0, 0.2, -0.2).applyQuaternion(drone.quaternion);
                        camera.position.copy(new THREE.Vector3().addVectors(drone.position, fpvOffset));
                        camera.quaternion.copy(drone.quaternion);
                        break;
                    case 'top': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 20, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'front': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 2, drone.position.z + 15), 0.1); camera.lookAt(drone.position); break;
                    case 'left': camera.position.lerp(new THREE.Vector3(drone.position.x - 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'right': camera.position.lerp(new THREE.Vector3(drone.position.x + 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'follow':
                    default:
                        const cameraOffset = new THREE.Vector3(0, 4, 10).applyQuaternion(drone.quaternion);
                        camera.position.lerp(new THREE.Vector3().addVectors(drone.position, cameraOffset), 0.1);
                        camera.lookAt(drone.position);
                        break;
                }
            }

            // --- UI INFO UPDATE ---
            const horizontalVelocity = Math.sqrt(physics.velocity.x**2 + physics.velocity.z**2);
            document.getElementById('velocity-info').innerText = `Velocity: H:${horizontalVelocity.toFixed(2)} V:${physics.velocity.y.toFixed(2)}`;
            cameraModeInfo.innerText = `View: ${cameraMode.charAt(0).toUpperCase() + cameraMode.slice(1)}`;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>
</html>