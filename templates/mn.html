<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mantis Navigation - 3JS Drone Test</title>
    <style>
    body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }
        #threejs-canvas {
            display: block;
        }
        #ui-container {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }
        .control-area {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #joystick-base {
            width: 150px;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
            pointer-events: all;
        }
        #joystick-stick {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            top: 40px;
            left: 40px;
            cursor: grab;
        }
        #thrust-container {
            width: 100px;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            gap: 15px;
        }
        #thrust-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 150px;
            height: 15px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            border-radius: 10px;
            transform: rotate(-90deg);
            cursor: pointer;
            margin: 0;
        }
        #thrust-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
        }
        #idle-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            font-family: 'Courier New', Courier, monospace;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 60px;
            transform: translateY(20px);
        }
        #idle-button:hover {
             background: rgba(255,255,255,0.4);
        }
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .model-action-btn {
            display: none;
            width: 100%;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            box-sizing: border-box;
        }
        .model-action-btn:hover {
             background-color: rgba(255, 255, 255, 0.5);
        }
        #upload-container {
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: rgba(0,0,0,0.7);
             padding: 20px;
             border-radius: 10px;
             text-align: center;
        }
         #initial-flip-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        #load-default-btn {
            margin-top: 15px;
            padding: 8px 16px;
            cursor: pointer;
            background-color: #444;
            color: white;
            border: 1px solid #666;
            border-radius: 5px;
        }
        #load-default-btn:hover {
            background-color: #555;
        }
        #view-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            pointer-events: all;
        }
        #fpv-toggle {
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
        }
        #fpv-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        #view-gizmo {
            display: grid;
            grid-template-columns: 25px 25px 25px;
            grid-template-rows: 25px 25px 25px;
            gap: 2px;
        }
        .gizmo-btn {
            background-color: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            user-select: none;
        }
        .gizmo-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        #gizmo-top    { grid-column: 2; grid-row: 1; }
        #gizmo-left   { grid-column: 1; grid-row: 2; }
        #gizmo-persp  { grid-column: 2; grid-row: 2; }
        #gizmo-right  { grid-column: 3; grid-row: 2; }
        #gizmo-front  { grid-column: 2; grid-row: 3; }
    </style>
</head>
<body>

    <canvas id="threejs-canvas"></canvas>

    <div id="info-panel">
         <div>
            <!-- MODIFIED: Replaced text title with logo image -->
           <img src="https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/templates/mn.png" alt="Mantis Navigation Logo" width="150" height="150" style="display: block; margin: 0 auto 5px auto;"><br><br>
            <span id="camera-mode-info">View: Follow</span><br>
            <span id="velocity-info">Velocity: (0, 0, 0)</span><br>
            <span id="thrust-info">Thrust: 0%</span>
        </div>
        <button id="reset-position-btn" class="model-action-btn" title="Reset drone to starting position">Return to Origin</button>
        <button id="change-model-btn" class="model-action-btn">Change Model</button>
    </div>

    <div id="upload-container">
        <h2>Upload Drone Model</h2>
        <p>Please select a .glb or .gltf file.</p>
        <input type="file" id="model-upload" accept=".glb, .gltf">
        <div id="initial-flip-container">
            <input type="checkbox" id="initial-flip-checkbox">
            <label for="initial-flip-checkbox">Flip Model 180Â° on Load</label>
        </div>
        <br>
        <button id="load-default-btn">Load ArielNPU</button>
    </div>

    <div id="view-controls" style="display: none;">
        <div id="fpv-toggle" title="Toggle First-Person View">FPV</div>
        <div id="view-gizmo">
            <div class="gizmo-btn" id="gizmo-top" title="Top View">T</div>
            <div class="gizmo-btn" id="gizmo-left" title="Left View">L</div>
            <div class="gizmo-btn" id="gizmo-persp" title="Perspective View">P</div>
            <div class="gizmo-btn" id="gizmo-right" title="Right View">R</div>
            <div class="gizmo-btn" id="gizmo-front" title="Front View">F</div>
        </div>
    </div>


    <div id="ui-container" style="display: none;">
        <div class="control-area">
            <div id="joystick-base">
                <div id="joystick-stick"></div>
            </div>
        </div>
        <div class="control-area">
            <div id="thrust-container">
                <label for="thrust-slider">Altitude</label>
                <input type="range" min="0" max="100" value="0" id="thrust-slider">
                <button id="idle-button" title="Set altitude to hover">Idle</button>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('threejs-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // --- LIGHTING & ENVIRONMENT ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);
        const gridHelper = new THREE.GridHelper(200, 50);
        scene.add(gridHelper);
        const ground = new THREE.Mesh( new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.9 }) );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // --- UI ELEMENTS ---
        const uploadContainer = document.getElementById('upload-container');
        const uiContainer = document.getElementById('ui-container');
        const viewControls = document.getElementById('view-controls');
        const modelUploadInput = document.getElementById('model-upload');
        const changeModelBtn = document.getElementById('change-model-btn');
        const loadDefaultBtn = document.getElementById('load-default-btn');
        const joystickBase = document.getElementById('joystick-base');
        const joystickStick = document.getElementById('joystick-stick');
        const thrustSlider = document.getElementById('thrust-slider');
        const idleButton = document.getElementById('idle-button');
        const fpvToggle = document.getElementById('fpv-toggle');
        const gizmoContainer = document.getElementById('view-gizmo');
        const cameraModeInfo = document.getElementById('camera-mode-info');
        const resetPositionBtn = document.getElementById('reset-position-btn');
        const initialFlipCheckbox = document.getElementById('initial-flip-checkbox');

        // --- MODEL & PHYSICS VARIABLES ---
        let drone;
        let modelMesh;
        const loader = new GLTFLoader();
        const physics = {
            velocity: new THREE.Vector3(),
            gravity: 0.015,
            drag: 0.98,
            lift: 0,
            maxLift: 0.03,
            thrustPower: 0.01,
            yawSpeed: 0.1
        };
        const controls = { joystick: { x: 0, y: 0 }, thrust: 0 };
        let cameraMode = 'follow';

        // --- CORE FUNCTIONS ---
        function reinitializeDroneState() {
            if (!drone) return;
            physics.velocity.set(0, 0, 0);
            controls.thrust = 0;
            thrustSlider.value = 0;
            resetJoystick();
            drone.quaternion.identity();
            cameraMode = 'follow';
            const cameraOffset = new THREE.Vector3(0, 4, 10);
            cameraOffset.applyQuaternion(drone.quaternion);
            const cameraPosition = new THREE.Vector3().addVectors(drone.position, cameraOffset);
            camera.position.copy(cameraPosition);
            camera.lookAt(drone.position);
        }

        function initializeSceneWithModel(gltf, shouldFlipOnLoad) {
            if (drone) scene.remove(drone);
            drone = new THREE.Group();
            drone.position.set(0, 5, 0);
            modelMesh = gltf.scene;
            if (shouldFlipOnLoad) {
                modelMesh.rotateY(Math.PI);
            }
            drone.add(modelMesh);
            scene.add(drone);
            reinitializeDroneState();
            uploadContainer.style.display = 'none';
            uiContainer.style.display = 'flex';
            viewControls.style.display = 'flex';
            changeModelBtn.style.display = 'block';
            resetPositionBtn.style.display = 'block';
        }

        // --- EVENT LISTENERS ---
        loadDefaultBtn.addEventListener('click', () => {
            const defaultModelPath = 'https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/ArielNPU.glb';
            loader.load(defaultModelPath, (gltf) => {
                initializeSceneWithModel(gltf, true);
            }, undefined, (error) => {
                 console.error(`Error loading default model:`, error);
                 alert(`Failed to load default model.`);
            });
        });

        changeModelBtn.addEventListener('click', () => {
            uploadContainer.style.display = 'block';
            uiContainer.style.display = 'none';
            viewControls.style.display = 'none';
            changeModelBtn.style.display = 'none';
            resetPositionBtn.style.display = 'none';
        });

        modelUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            loader.load(url, (gltf) => {
                const shouldFlip = initialFlipCheckbox.checked;
                initializeSceneWithModel(gltf, shouldFlip);
                URL.revokeObjectURL(url);
            }, undefined, (error) => {
                console.error('An error happened while loading the uploaded model:', error);
                alert('Failed to load model.');
                URL.revokeObjectURL(url);
            });
        });

        resetPositionBtn.addEventListener('click', () => {
            if (drone) {
                drone.position.set(0, 5, 0);
                reinitializeDroneState();
            }
        });

        // --- UI CONTROLS LOGIC ---
        let joystickActive = false;
        const handleJoystickMove = (x, y) => {
            const rect = joystickBase.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
            let dx = x - centerX; let dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDist = rect.width / 2;
            if (distance > maxDist) { dx = (dx / distance) * maxDist; dy = (dy / distance) * maxDist; }
            joystickStick.style.transform = `translate(${dx}px, ${dy}px)`;
            controls.joystick.x = dx / maxDist; controls.joystick.y = -dy / maxDist;
        };
        const resetJoystick = () => { joystickActive = false; joystickStick.style.transition = 'transform 0.2s'; joystickStick.style.transform = 'translate(0, 0)'; controls.joystick.x = 0; controls.joystick.y = 0; };
        joystickBase.addEventListener('mousedown', (e) => { joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mousemove', (e) => { if (joystickActive) handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mouseup', resetJoystick);
        joystickBase.addEventListener('touchstart', (e) => { e.preventDefault(); joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
        window.addEventListener('touchmove', (e) => { if (joystickActive) handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); });
        window.addEventListener('touchend', resetJoystick);
        thrustSlider.addEventListener('input', (e) => { controls.thrust = parseFloat(e.target.value) / 100.0; });
        idleButton.addEventListener('click', () => { const idleThrust = physics.gravity / physics.maxLift; controls.thrust = idleThrust; thrustSlider.value = idleThrust * 100; });
        fpvToggle.addEventListener('click', () => { cameraMode = (cameraMode === 'fpv') ? 'follow' : 'fpv'; });
        gizmoContainer.addEventListener('click', (e) => { const id = e.target.id; if (id.startsWith('gizmo-')) { cameraMode = id.replace('gizmo-', ''); if (cameraMode === 'persp') cameraMode = 'follow'; } });

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            if (drone) {
                // 1. Vertical Physics (Altitude from slider)
                physics.lift = controls.thrust * physics.maxLift;
                physics.velocity.y -= physics.gravity;
                physics.velocity.y += physics.lift;

                // 2. Rotational Physics (Yaw from joystick X)
                const yawRotation = new THREE.Quaternion().setFromAxisAngle(
                    new THREE.Vector3(0, 1, 0),
                   -controls.joystick.x * physics.yawSpeed
                );
                drone.quaternion.multiplyQuaternions(yawRotation, drone.quaternion);

                // 3. Horizontal Thrust (from joystick Y)
                const thrustVector = new THREE.Vector3(0, 0, -1);
                thrustVector.applyQuaternion(drone.quaternion);
                thrustVector.multiplyScalar(controls.joystick.y * physics.thrustPower);
                physics.velocity.add(thrustVector);

                // 4. Apply Drag and Update Position
                physics.velocity.multiplyScalar(physics.drag);
                drone.position.add(physics.velocity);

                // 5. Ground Collision
                if (drone.position.y < 0.5) {
                    drone.position.y = 0.5;
                    physics.velocity.y = 0;
                }

                // 6. Visual Flair (Banking and Pitching)
                modelMesh.rotation.z = -controls.joystick.x * 0.5;
                modelMesh.rotation.x = -controls.joystick.y * 0.3;

                // 7. Master Camera Update Logic
                modelMesh.visible = (cameraMode !== 'fpv');
                switch (cameraMode) {
                    case 'fpv':
                        const fpvOffset = new THREE.Vector3(0, 0.2, -0.2);
                        fpvOffset.applyQuaternion(drone.quaternion);
                        const fpvPosition = new THREE.Vector3().addVectors(drone.position, fpvOffset);
                        camera.position.copy(fpvPosition);
                        camera.quaternion.copy(drone.quaternion);
                        break;
                    case 'top': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 20, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'front': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 2, drone.position.z + 15), 0.1); camera.lookAt(drone.position); break;
                    case 'left': camera.position.lerp(new THREE.Vector3(drone.position.x - 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'right': camera.position.lerp(new THREE.Vector3(drone.position.x + 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'follow':
                    default:
                        const cameraOffset = new THREE.Vector3(0, 4, 10);
                        cameraOffset.applyQuaternion(drone.quaternion);
                        const cameraPosition = new THREE.Vector3().addVectors(drone.position, cameraOffset);
                        camera.position.lerp(cameraPosition, 0.1);
                        camera.lookAt(drone.position);
                        break;
                }
            }

            // Update UI Info
            const horizontalVelocity = Math.sqrt(physics.velocity.x**2 + physics.velocity.z**2);
            document.getElementById('velocity-info').innerText = `Velocity: H:${horizontalVelocity.toFixed(2)} V:${physics.velocity.y.toFixed(2)}`;
            document.getElementById('thrust-info').innerText = `Altitude: ${(controls.thrust * 100).toFixed(0)}%`;
            cameraModeInfo.innerText = `View: ${cameraMode.charAt(0).toUpperCase() + cameraMode.slice(1)}`;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();
    </script>
</body>
</html>