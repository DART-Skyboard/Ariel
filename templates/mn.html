<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mantis Navigation</title>
    <style>
    :root {
        --chem-panel-width: 340px;
    }
    body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }
        #threejs-canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        #ui-container {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 80%;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }
        .control-area {
            width: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #joystick-base {
            width: 150px;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
            pointer-events: all;
        }
        #joystick-stick {
            width: 70px;
            height: 70px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: absolute;
            top: 40px;
            left: 40px;
            cursor: grab;
        }
        #thrust-container {
            width: 100px;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: all;
            gap: 15px;
        }
        #thrust-slider {
            -webkit-appearance: none; appearance: none;
            width: 150px; height: 15px; background: rgba(255, 255, 255, 0.2);
            outline: none; border-radius: 10px; transform: rotate(-90deg);
            cursor: pointer; margin: 0;
        }
        #thrust-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 25px; height: 25px; background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
        }
        #idle-button {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; font-family: 'Courier New', Courier, monospace;
            padding: 8px 12px; border-radius: 5px; cursor: pointer;
            margin-top: 60px; transform: translateY(20px);
        }
        #idle-button:hover { background: rgba(255,255,255,0.4); }
        #info-panel {
            position: absolute; top: 10px; left: 10px;
            padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px;
            display: flex; flex-direction: column; gap: 8px; width: 290px;
            z-index: 10;
        }
        .model-action-btn {
            display: none; width: 100%; padding: 8px;
            background-color: rgba(255, 255, 255, 0.3); border: 1px solid rgba(255, 255, 255, 0.5);
            color: white; border-radius: 5px; cursor: pointer;
            font-family: 'Courier New', Courier, monospace; box-sizing: border-box;
        }
        .model-action-btn:hover { background-color: rgba(255, 255, 255, 0.5); }
        
        /* START: Chemistry Propulsion Styles */
        #chemistry-panel {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 325px;
            left: 10px;
            width: var(--chem-panel-width); box-sizing: border-box;
            padding: 15px; background: rgba(0,0,0,0.7);
            border-radius: 5px; border: 1px solid rgba(255,255,255,0.2);
            max-height: 60vh; overflow-y: auto; display: none;
            z-index: 10;
        }
        .chem-section {
            margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
        }
        .chem-section:last-child { border-bottom: none; }
        .chem-section h3, .chem-section h4 {
            margin: 0 0 10px 0; font-size: 1em; color: #ddd;
        }
        .chem-input-group {
            display: grid; grid-template-columns: auto 1fr;
            gap: 8px 10px; font-size: 0.85em; align-items: center;
        }
        .chem-input-group label { text-align: right; color: #aaa; }
        .chem-input-group input, .chem-input-group .output-span {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; font-family: 'Courier New', Courier, monospace;
            padding: 4px; border-radius: 3px; width: 100%; box-sizing: border-box;
        }
        .chem-input-group .output-span { background: transparent; border: 1px solid transparent; }
        .conversion-output {
            grid-column: 2; /* Place conversion text under the input */
            display: block;
            font-size: 0.9em;
            color: #9f9;
            margin-top: -4px;
            text-align: right;
        }
        .propellant-group {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px; padding: 10px; margin-bottom: 10px;
        }
        .propellant-group-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .propellant-group-header input { width: 70%; }
        .remove-group-btn {
            background: #800; color: white; border: 1px solid #c00;
            border-radius: 50%; width: 22px; height: 22px;
            cursor: pointer; line-height: 20px; text-align: center;
        }
        #chem-thrust-container {
            width: 50%; display: none; justify-content: space-around;
            align-items: flex-end; pointer-events: all;
        }
        .chem-slider-wrapper { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .chem-slider {
            -webkit-appearance: none; appearance: none; width: 150px; height: 15px;
            background: rgba(255, 255, 255, 0.2); outline: none; border-radius: 10px;
            transform: rotate(-90deg); cursor: pointer; margin-bottom: 60px;
        }
        .chem-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 25px; height: 25px; border-radius: 50%;
        }
        #chem-oxi-slider::-webkit-slider-thumb { background: rgba(100, 150, 255, 0.8); }
        #chem-fuel-slider::-webkit-slider-thumb { background: rgba(255, 100, 100, 0.8); }
        #chem-master-slider::-webkit-slider-thumb { background: rgba(255, 255, 255, 0.8); }
        /* END: Chemistry Propulsion Styles */

        #upload-container {
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; text-align: center;
             z-index: 20;
        }
        #initial-flip-container {
            margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        #load-default-btn, #load-default-btn2, #load-default-btn3, #add-group-btn {
            margin-top: 15px; padding: 8px 16px; cursor: pointer; background-color: #444;
            color: white; border: 1px solid #666; border-radius: 5px;
        }
        #load-default-btn:hover, #load-default-btn2:hover, #load-default-btn3:hover, #add-group-btn:hover { background-color: #555; }
        
        #view-controls {
            position: absolute; top: 10px; right: 10px; display: flex;
            align-items: center; gap: 10px; pointer-events: all;
            z-index: 10;
        }
        #fpv-toggle, .gizmo-btn {
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.4);
            cursor: pointer; display: flex; justify-content: center;
            align-items: center; color: white;
        }
        #fpv-toggle { width: 40px; height: 40px; border-radius: 5px; font-size: 10px; }
        #fpv-toggle:hover, .gizmo-btn:hover { background: rgba(255,255,255,0.3); }
        
        #view-gizmo { display: grid; grid-template-columns: 25px 25px 25px; grid-template-rows: 25px 25px 25px; gap: 2px; }
        .gizmo-btn { font-size: 10px; user-select: none; }
        #gizmo-top { grid-column: 2; grid-row: 1; }
        #gizmo-left { grid-column: 1; grid-row: 2; }
        #gizmo-persp { grid-column: 2; grid-row: 2; }
        #gizmo-right { grid-column: 3; grid-row: 2; }
        #gizmo-front { grid-column: 2; grid-row: 3; }
    </style>
</head>
<body>

    <canvas id="threejs-canvas"></canvas>

    <div id="info-panel">
         <div>
           <img src="https://raw.githubusercontent.com/DART-Skyboard/Ariel/refs/heads/main/templates/mn.png" alt="Mantis Navigation Logo" width="150" height="150" style="display: block; margin: 0 auto 5px auto;"><br><br>
            <span id="camera-mode-info">View: Follow</span><br>
            <span id="velocity-info">Velocity: (0, 0, 0)</span><br>
            <span id="thrust-info">Thrust: 0%</span>
        </div>
        <button id="reset-position-btn" class="model-action-btn" title="Reset drone to starting position">Return to Origin</button>
        <button id="change-model-btn" class="model-action-btn">Change Model</button>
        <button id="chem-propulsion-btn" class="model-action-btn">Chemistry Propulsion</button>
    </div>

    <div id="chemistry-panel">
        <div id="model-settings-container" class="chem-section">
            <h3>Model Settings</h3>
            <div class="chem-input-group">
                <label for="model-mass">Mass:</label> <input type="number" id="model-mass" value="1.0">
                <label for="model-volume">Volume:</label> <input type="number" id="model-volume" class="volume-input" value="1.0">
                <label>Weight (lbs):</label> <input type="number" id="model-weight" value="2.2">
                <label for="model-density">Density:</label> <input type="number" id="model-density" value="1.225">
                <label>Temp. (°F):</label> <input type="number" id="model-temp" class="temp-input" value="4190">
                <span class="conversion-output"></span>
                <label>Exh. Vel. (mph):</label> <input type="number" id="model-velocity" class="velocity-input" value="6500">
                <span class="conversion-output"></span>
                <label>Surf. Area:</label> <span class="output-span surface-area-output">4.84</span>
                <label for="model-pressure">ATM Press.:</label> <input type="number" id="model-pressure" value="14.7">
            </div>
        </div>
        <div id="propellant-groups-container">
             <h3>Propellant Groups</h3>
             <div id="propellant-groups-list"></div>
             <button id="add-group-btn" style="width:100%; margin-top: 5px;">+ Add Group</button>
        </div>
    </div>
    
    <template id="propellant-group-template">
        <div class="propellant-group">
            <div class="propellant-group-header">
                <input type="text" class="group-name-input" value="Group Name">
                <button class="remove-group-btn">-</button>
            </div>
            <!-- Oxidizer Section -->
            <div class="chem-section" style="padding-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.2);">
                 <h4>Oxidizer</h4>
                 <div class="chem-input-group">
                    <label>Mass:</label> <input type="number" class="prop-mass" value="1140">
                    <label>Volume:</label> <input type="number" class="prop-volume volume-input" value="1">
                    <label>Weight (lbs):</label> <input type="number" class="prop-weight" value="2513">
                    <label>Density:</label> <input type="number" class="prop-density" value="1.14">
                    <label>Temp. (°F):</label> <input type="number" class="prop-temp temp-input" value="-297">
                    <span class="conversion-output"></span>
                    <label>Exh. Vel. (mph):</label> <input type="number" class="prop-velocity velocity-input" value="6000">
                    <span class="conversion-output"></span>
                    <label>Surf. Area:</label> <span class="output-span surface-area-output"></span>
                    <label>ATM Press.:</label> <input type="number" class="prop-pressure" value="14.7">
                 </div>
            </div>
            <!-- Fuel Section -->
             <div class="chem-section" style="border-bottom:none; padding-bottom:0; margin-bottom: 0;">
                 <h4>Fuel</h4>
                 <div class="chem-input-group">
                    <label>Mass:</label> <input type="number" class="prop-mass" value="850">
                    <label>Volume:</label> <input type="number" class="prop-volume volume-input" value="1">
                    <label>Weight (lbs):</label> <input type="number" class="prop-weight" value="1874">
                    <label>Density:</label> <input type="number" class="prop-density" value="0.85">
                    <label>Temp. (°F):</label> <input type="number" class="prop-temp temp-input" value="77">
                    <span class="conversion-output"></span>
                    <label>Exh. Vel. (mph):</label> <input type="number" class="prop-velocity velocity-input" value="7200">
                    <span class="conversion-output"></span>
                    <label>Surf. Area:</label> <span class="output-span surface-area-output"></span>
                    <label>ATM Press.:</label> <input type="number" class="prop-pressure" value="14.7">
                 </div>
            </div>
        </div>
    </template>

    <div id="upload-container">
        <h2>Upload Navigation Model</h2>
        <p>Please select a .glb or .gltf file.</p>
        <input type="file" id="model-upload" accept=".glb, .gltf">
        <div id="initial-flip-container">
            <input type="checkbox" id="initial-flip-checkbox">
            <label for="initial-flip-checkbox">Flip Model 180° on Load</label>
        </div>
        <br>
        <button id="load-default-btn">Load | ArielNPU</button>
        <br>
        <button id="load-default-btn2">Load | Arrow</button>
        <button id="load-default-btn3">Load | Ariel & Mantis Gimbal</button>
    </div>

    <div id="view-controls" style="display: none;">
        <div id="fpv-toggle" title="Toggle First-Person View">FPV</div>
        <div id="view-gizmo">
            <div class="gizmo-btn" id="gizmo-top" title="Top View">T</div>
            <div class="gizmo-btn" id="gizmo-left" title="Left View">L</div>
            <div class="gizmo-btn" id="gizmo-persp" title="Perspective View">P</div>
            <div class="gizmo-btn" id="gizmo-right" title="Right View">R</div>
            <div class="gizmo-btn" id="gizmo-front" title="Front View">F</div>
        </div>
    </div>

    <div id="ui-container" style="display: none;">
        <div class="control-area">
            <div id="joystick-base">
                <div id="joystick-stick"></div>
            </div>
        </div>
        <div class="control-area">
            <div id="thrust-container">
                <label for="thrust-slider">Altitude</label>
                <input type="range" min="0" max="100" value="0" id="thrust-slider">
                <button id="idle-button" title="Set altitude to hover">Idle</button>
            </div>
            <div id="chem-thrust-container">
                <div class="chem-slider-wrapper">
                    <label for="chem-oxi-slider">Oxidizer</label>
                    <input type="range" min="0" max="100" value="50" id="chem-oxi-slider" class="chem-slider">
                </div>
                 <div class="chem-slider-wrapper">
                    <label for="chem-fuel-slider">Fuel</label>
                    <input type="range" min="0" max="100" value="50" id="chem-fuel-slider" class="chem-slider">
                </div>
                 <div class="chem-slider-wrapper">
                    <label for="chem-master-slider">Master</label>
                    <input type="range" min="0" max="100" value="0" id="chem-master-slider" class="chem-slider">
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('threejs-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // --- LIGHTING & ENVIRONMENT ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);
        scene.add(new THREE.GridHelper(200, 50));
        const ground = new THREE.Mesh( new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.9 }) );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // --- UI ELEMENTS ---
        const uploadContainer = document.getElementById('upload-container');
        const uiContainer = document.getElementById('ui-container');
        const viewControls = document.getElementById('view-controls');
        const modelUploadInput = document.getElementById('model-upload');
        const changeModelBtn = document.getElementById('change-model-btn');
        const loadDefaultBtn = document.getElementById('load-default-btn');
        const loadDefaultBtn2 = document.getElementById('load-default-btn2');
        const loadDefaultBtn3 = document.getElementById('load-default-btn3');
        const joystickBase = document.getElementById('joystick-base');
        const joystickStick = document.getElementById('joystick-stick');
        const thrustSlider = document.getElementById('thrust-slider');
        const idleButton = document.getElementById('idle-button');
        const fpvToggle = document.getElementById('fpv-toggle');
        const gizmoContainer = document.getElementById('view-gizmo');
        const cameraModeInfo = document.getElementById('camera-mode-info');
        const resetPositionBtn = document.getElementById('reset-position-btn');
        const initialFlipCheckbox = document.getElementById('initial-flip-checkbox');
        // --- NEW CHEMISTRY UI ELEMENTS ---
        const infoPanel = document.getElementById('info-panel');
        const chemPropulsionBtn = document.getElementById('chem-propulsion-btn');
        const chemistryPanel = document.getElementById('chemistry-panel');
        const thrustContainer = document.getElementById('thrust-container');
        const chemThrustContainer = document.getElementById('chem-thrust-container');
        const propellantGroupsList = document.getElementById('propellant-groups-list');
        const propellantGroupTemplate = document.getElementById('propellant-group-template');




        // --- MODEL & PHYSICS VARIABLES ---
        let drone, modelMesh;
        const loader = new GLTFLoader();
        const physics = {
            velocity: new THREE.Vector3(),
            baseGravity: 0.015,
            drag: 0.98,
            lift: 0,
            baseMaxLift: 0.03, // Original maxLift is now the base for standard mode
            thrustPower: 0.01,
            yawSpeed: 0.1,
            optimalTempF: 4200,
            tempFalloff: 500000,
        };
        const controls = { joystick: { x: 0, y: 0 }, thrust: 0 };
        let cameraMode = 'follow', chemistryModeActive = false, groupCounter = 0;


        // --- UNIT CONVERSION & DISPLAY FUNCTIONS ---
        const fahrenheitToCelsius = (f) => (f - 32) * 5 / 9;
        const mphToKph = (mph) => mph * 1.60934;
        const mphToMps = (mph) => mph * 0.44704;
        const calculateSurfaceArea = (volume) => volume <= 0 ? 0 : Math.pow(4 * Math.PI, 1/3) * Math.pow(3 * volume, 2/3);

        function updateTempConversion(input) {
            const f = parseFloat(input.value) || 0;
            const c = fahrenheitToCelsius(f);
            input.parentElement.querySelector('.conversion-output').textContent = `${c.toFixed(1)} °C`;
        }
        function updateVelocityConversion(input) {
            const mph = parseFloat(input.value) || 0;
            const kph = mphToKph(mph);
            const mps = mphToMps(mph);
            input.parentElement.querySelector('.conversion-output').textContent = `${kph.toFixed(1)} km/h | ${mps.toFixed(1)} m/s`;
        }
        function updateSurfaceAreaDisplay(volumeInput) {
            const volume = parseFloat(volumeInput.value) || 0;
            const area = calculateSurfaceArea(volume);
            const outputSpan = volumeInput.closest('.chem-input-group').querySelector('.surface-area-output');
            if(outputSpan) outputSpan.textContent = area.toFixed(2);
        }

        // --- CORE FUNCTIONS ---
        function reinitializeDroneState() {
            if (!drone) return;
            physics.velocity.set(0, 0, 0);
            controls.thrust = 0;
            thrustSlider.value = 0;
            resetJoystick();
            drone.quaternion.identity();
            cameraMode = 'follow';
            const cameraOffset = new THREE.Vector3(0, 4, 10);
            cameraOffset.applyQuaternion(drone.quaternion);
            const cameraPosition = new THREE.Vector3().addVectors(drone.position, cameraOffset);
            camera.position.copy(cameraPosition);
            camera.lookAt(drone.position);
        }

        function initializeSceneWithModel(gltf, shouldFlipOnLoad) {
            if (drone) scene.remove(drone);
            drone = new THREE.Group();
            drone.position.set(0, 5, 0);
            modelMesh = gltf.scene;
            if (shouldFlipOnLoad) {
                modelMesh.rotateY(Math.PI);
            }
            drone.add(modelMesh);
            scene.add(drone);
            reinitializeDroneState();
            resetChemistryPanel(); // Reset and set up chemistry panel
            uploadContainer.style.display = 'none';
            uiContainer.style.display = 'flex';
            viewControls.style.display = 'flex';
            changeModelBtn.style.display = 'block';
            resetPositionBtn.style.display = 'block';
            chemPropulsionBtn.style.display = 'block'; // Show the new button
        }
        
        // --- CHEMISTRY MODE FUNCTIONS ---
        function toggleChemistryMode() {
            chemistryModeActive = !chemistryModeActive;
            
            if (chemistryModeActive) {
                const infoPanelRect = infoPanel.getBoundingClientRect();
                chemistryPanel.style.top = `${infoPanelRect.bottom + 25}px`;
                chemistryPanel.style.display = 'block';
            } else {
                 chemistryPanel.style.display = 'none';
            }
            
            thrustContainer.style.display = chemistryModeActive ? 'none' : 'flex';
            chemThrustContainer.style.display = chemistryModeActive ? 'flex' : 'none';
            chemPropulsionBtn.style.background = chemistryModeActive ? 'rgba(100, 200, 100, 0.5)' : '';
            chemPropulsionBtn.textContent = chemistryModeActive ? 'Exit Chemistry' : 'Chemistry Propulsion';
        }

        function addPropellantGroup() {
            groupCounter++;
            const groupClone = propellantGroupTemplate.content.cloneNode(true);
            const groupDiv = groupClone.querySelector('.propellant-group');
            groupDiv.querySelector('.group-name-input').value = `Propellant ${groupCounter}`;
            groupDiv.querySelector('.remove-group-btn').addEventListener('click', () => groupDiv.remove());

            groupDiv.querySelectorAll('.temp-input').forEach(input => {
                input.addEventListener('input', () => updateTempConversion(input));
                updateTempConversion(input);
            });
            groupDiv.querySelectorAll('.velocity-input').forEach(input => {
                input.addEventListener('input', () => updateVelocityConversion(input));
                updateVelocityConversion(input);
            });
            groupDiv.querySelectorAll('.volume-input').forEach(input => {
                input.addEventListener('input', () => updateSurfaceAreaDisplay(input));
                updateSurfaceAreaDisplay(input);
            });
            
            propellantGroupsList.appendChild(groupClone);
        }
        
        function resetChemistryPanel() {
            document.querySelectorAll('#model-settings-container input').forEach(input => {
                if (input.type !== 'button') input.value = input.defaultValue;
            });
            updateSurfaceAreaDisplay(document.getElementById('model-volume'));
            updateTempConversion(document.getElementById('model-temp'));
            updateVelocityConversion(document.getElementById('model-velocity'));
            
            propellantGroupsList.innerHTML = ''; groupCounter = 0; addPropellantGroup();
            
            document.getElementById('chem-oxi-slider').value = 50;
            document.getElementById('chem-fuel-slider').value = 50;
            document.getElementById('chem-master-slider').value = 0;

            if (chemistryModeActive) toggleChemistryMode();
        }

        // --- EVENT LISTENERS ---
        loadDefaultBtn.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/ArielNPU.glb', (gltf) => initializeSceneWithModel(gltf, true)));
        loadDefaultBtn2.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/Arrow.glb', (gltf) => initializeSceneWithModel(gltf, true)));
        loadDefaultBtn3.addEventListener('click', () => loader.load('https://raw.githubusercontent.com/DART-Skyboard/Ariel/main/templates/MantisGimbal.glb', (gltf) => initializeSceneWithModel(gltf, true)));

        changeModelBtn.addEventListener('click', () => {
            uploadContainer.style.display = 'block';
            uiContainer.style.display = 'none';
            viewControls.style.display = 'none';
            changeModelBtn.style.display = 'none';
            resetPositionBtn.style.display = 'none';
            chemPropulsionBtn.style.display = 'none'; // Hide chem button
            if (chemistryModeActive) toggleChemistryMode(); // Turn off chem mode
            chemistryPanel.style.display = 'none'; // Hide panel
        });

        modelUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            loader.load(url, (gltf) => {
                initializeSceneWithModel(gltf, initialFlipCheckbox.checked);
                URL.revokeObjectURL(url);
            });
        });

        resetPositionBtn.addEventListener('click', () => {
            if (drone) {
                drone.position.set(0, 5, 0);
                reinitializeDroneState();
            }
        });

        // --- NEW EVENT LISTENERS ---
        chemPropulsionBtn.addEventListener('click', toggleChemistryMode);
        document.getElementById('add-group-btn').addEventListener('click', addPropellantGroup);
        document.addEventListener('DOMContentLoaded', resetChemistryPanel);

        // --- UI CONTROLS LOGIC ---
        let joystickActive = false;
        const handleJoystickMove = (x, y) => {
            const rect = joystickBase.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
            let dx = x - centerX; let dy = y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDist = rect.width / 2;
            if (distance > maxDist) { dx = (dx / distance) * maxDist; dy = (dy / distance) * maxDist; }
            joystickStick.style.transform = `translate(${dx}px, ${dy}px)`;
            controls.joystick.x = dx / maxDist; controls.joystick.y = -dy / maxDist;
        };
        const resetJoystick = () => { joystickActive = false; joystickStick.style.transition = 'transform 0.2s'; joystickStick.style.transform = 'translate(0, 0)'; controls.joystick.x = 0; controls.joystick.y = 0; };
        joystickBase.addEventListener('mousedown', (e) => { joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mousemove', (e) => { if (joystickActive) handleJoystickMove(e.clientX, e.clientY); });
        window.addEventListener('mouseup', resetJoystick);
        joystickBase.addEventListener('touchstart', (e) => { e.preventDefault(); joystickActive = true; joystickStick.style.transition = ''; handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
        window.addEventListener('touchmove', (e) => { if (joystickActive) handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY); });
        window.addEventListener('touchend', resetJoystick);
        
        thrustSlider.addEventListener('input', (e) => { controls.thrust = parseFloat(e.target.value) / 100.0; });
        idleButton.addEventListener('click', () => { 
            const idleThrust = physics.baseGravity / physics.baseMaxLift; 
            controls.thrust = idleThrust; 
            thrustSlider.value = idleThrust * 100; 
        });
        
        // Master slider logic that moves oxidizer and fuel from their current values



        fpvToggle.addEventListener('click', () => { cameraMode = (cameraMode === 'fpv') ? 'follow' : 'fpv'; });
        gizmoContainer.addEventListener('click', (e) => { const id = e.target.id; if (id.startsWith('gizmo-')) { cameraMode = id.replace('gizmo-', ''); if (cameraMode === 'persp') cameraMode = 'follow'; } });


// Master Slider Delta-Based Control Logic

const chemOxiSlider = document.getElementById('chem-oxi-slider');
const chemFuelSlider = document.getElementById('chem-fuel-slider');
const chemMasterSlider = document.getElementById('chem-master-slider');

let masterSliderDragState = {
    active: false,
    initialMaster: 0,
    initialOxi: 0,
    initialFuel: 0
};

// On slider press/touch, capture current states
function startMasterDrag() {
    masterSliderDragState.active = true;
    masterSliderDragState.initialMaster = parseFloat(chemMasterSlider.value);
    masterSliderDragState.initialOxi = parseFloat(chemOxiSlider.value);
    masterSliderDragState.initialFuel = parseFloat(chemFuelSlider.value);
}

// On release, stop dragging state
function endMasterDrag() {
    masterSliderDragState.active = false;
}

// During drag, apply the delta to both sliders
function onMasterDrag() {
    if (!masterSliderDragState.active) return;

    const currentMaster = parseFloat(chemMasterSlider.value);
    const delta = currentMaster - masterSliderDragState.initialMaster;

    const newOxi = masterSliderDragState.initialOxi + delta;
    const newFuel = masterSliderDragState.initialFuel + delta;

    chemOxiSlider.value = Math.min(100, Math.max(0, newOxi.toFixed(2)));
    chemFuelSlider.value = Math.min(100, Math.max(0, newFuel.toFixed(2)));
}

// Event bindings
chemMasterSlider.addEventListener('mousedown', startMasterDrag);
chemMasterSlider.addEventListener('touchstart', startMasterDrag);
window.addEventListener('mouseup', endMasterDrag);
window.addEventListener('touchend', endMasterDrag);
chemMasterSlider.addEventListener('input', onMasterDrag);



        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            if (drone) {
                // --- PHYSICS LOGIC ---
                if (chemistryModeActive) {
                    const modelMass = parseFloat(document.getElementById('model-mass').value) || 1;
                    const exhaustVelocity = parseFloat(document.getElementById('model-velocity').value) || 1;
                    const tempF = parseFloat(document.getElementById('model-temp').value) || 0;
                    const appliedGravity = physics.baseGravity * modelMass;
                    const dynamicMaxLift = physics.baseMaxLift * (exhaustVelocity / 6500);
                    const masterValue = parseFloat(document.getElementById('chem-master-slider').value) / 100;
                    const oxiValue = parseFloat(document.getElementById('chem-oxi-slider').value) / 100;
                    const fuelValue = parseFloat(document.getElementById('chem-fuel-slider').value) / 100;
                    const mixtureRatio = (oxiValue > 0.01 && fuelValue > 0.01) ? Math.min(oxiValue, fuelValue) / Math.max(oxiValue, fuelValue) : 0;
                    const mixtureEfficiency = Math.pow(mixtureRatio, 2);
                    const tempDiff = tempF - physics.optimalTempF;
                    const tempEfficiency = Math.exp(-Math.pow(tempDiff, 2) / physics.tempFalloff);

                    physics.lift = masterValue * mixtureEfficiency * tempEfficiency * dynamicMaxLift;
                    
                    document.getElementById('thrust-info').innerText = `Master: ${(masterValue * 100).toFixed(0)}% | Eff: ${(mixtureEfficiency * tempEfficiency * 100).toFixed(0)}%`;
                    physics.velocity.y -= appliedGravity;
                } else {
                    // Original simple physics
                    physics.lift = controls.thrust * physics.baseMaxLift;
                    document.getElementById('thrust-info').innerText = `Altitude: ${(controls.thrust * 100).toFixed(0)}%`;
                    physics.velocity.y -= physics.baseGravity;
                }
                
                // Universal physics (applied in both modes)
                physics.velocity.y += physics.lift;
                const yawRotation = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), -controls.joystick.x * physics.yawSpeed);
                drone.quaternion.multiplyQuaternions(yawRotation, drone.quaternion);
                const thrustVector = new THREE.Vector3(0, 0, -1).applyQuaternion(drone.quaternion).multiplyScalar(controls.joystick.y * physics.thrustPower);
                physics.velocity.add(thrustVector);
                physics.velocity.multiplyScalar(physics.drag);
                drone.position.add(physics.velocity);

                if (drone.position.y < 0.5) {
                    drone.position.y = 0.5;
                    physics.velocity.y = 0;
                }
                
                modelMesh.rotation.z = -controls.joystick.x * 0.5;
                modelMesh.rotation.x = -controls.joystick.y * 0.3;

                // --- CAMERA UPDATE LOGIC ---
                modelMesh.visible = (cameraMode !== 'fpv');
                switch (cameraMode) {
                    case 'fpv':
                        const fpvOffset = new THREE.Vector3(0, 0.2, -0.2).applyQuaternion(drone.quaternion);
                        camera.position.copy(new THREE.Vector3().addVectors(drone.position, fpvOffset));
                        camera.quaternion.copy(drone.quaternion);
                        break;
                    case 'top': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 20, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'front': camera.position.lerp(new THREE.Vector3(drone.position.x, drone.position.y + 2, drone.position.z + 15), 0.1); camera.lookAt(drone.position); break;
                    case 'left': camera.position.lerp(new THREE.Vector3(drone.position.x - 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'right': camera.position.lerp(new THREE.Vector3(drone.position.x + 15, drone.position.y + 2, drone.position.z), 0.1); camera.lookAt(drone.position); break;
                    case 'follow':
                    default:
                        const cameraOffset = new THREE.Vector3(0, 4, 10).applyQuaternion(drone.quaternion);
                        camera.position.lerp(new THREE.Vector3().addVectors(drone.position, cameraOffset), 0.1);
                        camera.lookAt(drone.position);
                        break;
                }
            }

            // --- UI INFO UPDATE ---
            const horizontalVelocity = Math.sqrt(physics.velocity.x**2 + physics.velocity.z**2);
            document.getElementById('velocity-info').innerText = `Velocity: H:${horizontalVelocity.toFixed(2)} V:${physics.velocity.y.toFixed(2)}`;
            cameraModeInfo.innerText = `View: ${cameraMode.charAt(0).toUpperCase() + cameraMode.slice(1)}`;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        animate();




    </script>
</body>
</html>