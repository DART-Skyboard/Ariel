<!-- Add inside <div id="userMenuDropdown"> -->
<button id="accountSettingsBtn" style="display:block; width:100%; margin:4px 0; background: deepskyblue; border:none; padding:6px; color:#fff; border-radius:5px; cursor:pointer;">Account Settings</button>
<div id="accountSettingsSection" style="display:none; margin-top:8px;">
  <hr style="border-color:#555; margin:8px 0;" />
  <!-- Change Email -->
  <h4 style="color:#fff; margin:4px 0;">Change Email</h4>
  <label style="display:block; margin:4px 0; color:#fff;">Current Password:
    <input type="password" id="currentEmailPwd" placeholder="Enter current password" style="width:100%; padding:4px; margin-top:2px;" />
  </label>
  <label style="display:block; margin:4px 0; color:#fff;">New Email:
    <input type="email" id="newEmail" placeholder="Enter new email" style="width:100%; padding:4px; margin-top:2px;" />
  </label>
  <button onclick="changeEmail()" style="display:block; width:100%; margin:6px 0; background: #28a745; border:none; padding:6px; color:#fff; border-radius:5px; cursor:pointer;">Change Email</button>
  <hr style="border-color:#555; margin:8px 0;" />
  <!-- Change Password -->
  <h4 style="color:#fff; margin:4px 0;">Change Password</h4>
  <label style="display:block; margin:4px 0; color:#fff;">Current Password:
    <input type="password" id="currentPwd" placeholder="Enter current password" style="width:100%; padding:4px; margin-top:2px;" />
  </label>
  <label style="display:block; margin:4px 0; color:#fff;">New Password:
    <input type="password" id="newPwd" placeholder="Enter new password" style="width:100%; padding:4px; margin-top:2px;" />
  </label>
  <button onclick="changePassword()" style="display:block; width:100%; margin:6px 0; background: #28a745; border:none; padding:6px; color:#fff; border-radius:5px; cursor:pointer;">Change Password</button>
</div>

<!-- Add these functions in your <script> where other user actions are handled -->
<script>
  // Toggle settings section
  document.getElementById('accountSettingsBtn').addEventListener('click', () => {
    const sec = document.getElementById('accountSettingsSection');
    sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
  });

  // Change Email handler
  async function changeEmail() {
    const u = getUser();
    const currentPwd = document.getElementById('currentEmailPwd').value;
    const newEmail = document.getElementById('newEmail').value;
    const form = new URLSearchParams({
      action: 'changeEmail',
      username: u.username,
      currentEmail: u.email,
      currentPassword: currentPwd,
      newEmail: newEmail
    });
    const res = await fetch(GS_URL, { method: 'POST', body: form });
    const j = await res.json();
    if (j.ok) {
      u.email = newEmail;
      saveUser(u);
      document.getElementById('menuEmail').innerText = newEmail;
      alert('Email changed successfully');
      document.getElementById('accountSettingsSection').style.display = 'none';
    } else {
      alert(j.error || 'Failed to change email');
    }
  }

  // Change Password handler
  async function changePassword() {
    const u = getUser();
    const currentPwd = document.getElementById('currentPwd').value;
    const newPwd = document.getElementById('newPwd').value;
    const form = new URLSearchParams({
      action: 'changePassword',
      username: u.username,
      currentEmail: u.email,
      currentPassword: currentPwd,
      newPassword: newPwd
    });
    const res = await fetch(GS_URL, { method: 'POST', body: form });
    const j = await res.json();
    if (j.ok) {
      alert('Password changed successfully');
      document.getElementById('accountSettingsSection').style.display = 'none';
    } else {
      alert(j.error || 'Failed to change password');
    }
  }
</script>
